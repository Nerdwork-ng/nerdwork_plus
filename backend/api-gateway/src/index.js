import express from "express";
import cors from "cors";
import helmet from "helmet";
import compression from "compression";
import morgan from "morgan";
import { createProxyMiddleware } from 'http-proxy-middleware';
import { globalErrorHandler, globalNotFoundHandler } from "./middleware/common.js";
const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cors());
app.use(helmet());
app.use(compression());
app.use(morgan("dev"));
// Service URLs - these would come from environment variables in production
const services = {
    auth: process.env.AUTH_SERVICE_URL || 'http://localhost:3001',
    user: process.env.USER_SERVICE_URL || 'http://localhost:3002',
    comic: process.env.COMIC_SERVICE_URL || 'http://localhost:3003',
    wallet: process.env.WALLET_SERVICE_URL || 'http://localhost:3004',
    event: process.env.EVENT_SERVICE_URL || 'http://localhost:3005',
    ledger: process.env.LEDGER_SERVICE_URL || 'http://localhost:3006',
};
// Health check for the gateway itself
app.get("/health", (req, res) => {
    res.status(200).json({
        status: "healthy",
        service: "api-gateway",
        timestamp: new Date().toISOString(),
        upstreamServices: services
    });
});
// Route requests to appropriate microservices
app.use('/auth', createProxyMiddleware({
    target: services.auth,
    changeOrigin: true,
    pathRewrite: {
        '^/auth': '/auth'
    },
    onError: (err, req, res) => {
        console.error('Auth Service Proxy Error:', err.message);
        res.status(503).json({
            success: false,
            error: 'Auth service unavailable',
            timestamp: new Date().toISOString()
        });
    }
}));
app.use('/users', createProxyMiddleware({
    target: services.user,
    changeOrigin: true,
    pathRewrite: {
        '^/users': '/users'
    },
    onError: (err, req, res) => {
        console.error('User Service Proxy Error:', err.message);
        res.status(503).json({
            success: false,
            error: 'User service unavailable',
            timestamp: new Date().toISOString()
        });
    }
}));
app.use('/comics', createProxyMiddleware({
    target: services.comic,
    changeOrigin: true,
    pathRewrite: {
        '^/comics': '/comics'
    },
    onError: (err, req, res) => {
        console.error('Comic Service Proxy Error:', err.message);
        res.status(503).json({
            success: false,
            error: 'Comic service unavailable',
            timestamp: new Date().toISOString()
        });
    }
}));
app.use('/wallet', createProxyMiddleware({
    target: services.wallet,
    changeOrigin: true,
    pathRewrite: {
        '^/wallet': '/wallet'
    },
    onError: (err, req, res) => {
        console.error('Wallet Service Proxy Error:', err.message);
        res.status(503).json({
            success: false,
            error: 'Wallet service unavailable',
            timestamp: new Date().toISOString()
        });
    }
}));
app.use('/events', createProxyMiddleware({
    target: services.event,
    changeOrigin: true,
    pathRewrite: {
        '^/events': '/events'
    },
    onError: (err, req, res) => {
        console.error('Event Service Proxy Error:', err.message);
        res.status(503).json({
            success: false,
            error: 'Event service unavailable',
            timestamp: new Date().toISOString()
        });
    }
}));
app.use('/ledger', createProxyMiddleware({
    target: services.ledger,
    changeOrigin: true,
    pathRewrite: {
        '^/ledger': '/ledger'
    },
    onError: (err, req, res) => {
        console.error('Ledger Service Proxy Error:', err.message);
        res.status(503).json({
            success: false,
            error: 'Ledger service unavailable',
            timestamp: new Date().toISOString()
        });
    }
}));
app.use(globalNotFoundHandler);
app.use(globalErrorHandler);
const PORT = process.env.PORT || 3000;
if (process.env.NODE_ENV !== 'production') {
    app.listen(PORT, () => {
        console.log(`API Gateway running at http://localhost:${PORT}`);
        console.log('Routing to services:', services);
    });
}
export { app };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDOUIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLFdBQVcsTUFBTSxhQUFhLENBQUM7QUFDdEMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRW5GLE1BQU0sR0FBRyxHQUFHLE9BQU8sRUFBRSxDQUFDO0FBRXRCLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7QUFDeEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNoRCxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7QUFDaEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBQ2xCLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUN2QixHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBRXZCLDJFQUEyRTtBQUMzRSxNQUFNLFFBQVEsR0FBRztJQUNmLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLHVCQUF1QjtJQUM3RCxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSx1QkFBdUI7SUFDN0QsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMs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dCBleHByZXNzIGZyb20gXCJleHByZXNzXCI7XHJcbmltcG9ydCBjb3JzIGZyb20gXCJjb3JzXCI7XHJcbmltcG9ydCBoZWxtZXQgZnJvbSBcImhlbG1ldFwiO1xyXG5pbXBvcnQgY29tcHJlc3Npb24gZnJvbSBcImNvbXByZXNzaW9uXCI7XHJcbmltcG9ydCBtb3JnYW4gZnJvbSBcIm1vcmdhblwiO1xyXG5pbXBvcnQgeyBjcmVhdGVQcm94eU1pZGRsZXdhcmUgfSBmcm9tICdodHRwLXByb3h5LW1pZGRsZXdhcmUnO1xyXG5pbXBvcnQgeyBnbG9iYWxFcnJvckhhbmRsZXIsIGdsb2JhbE5vdEZvdW5kSGFuZGxlciB9IGZyb20gXCIuL21pZGRsZXdhcmUvY29tbW9uLmpzXCI7XHJcblxyXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XHJcblxyXG5hcHAudXNlKGV4cHJlc3MuanNvbigpKTtcclxuYXBwLnVzZShleHByZXNzLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSk7XHJcbmFwcC51c2UoY29ycygpKTtcclxuYXBwLnVzZShoZWxtZXQoKSk7XHJcbmFwcC51c2UoY29tcHJlc3Npb24oKSk7XHJcbmFwcC51c2UobW9yZ2FuKFwiZGV2XCIpKTtcclxuXHJcbi8vIFNlcnZpY2UgVVJMcyAtIHRoZXNlIHdvdWxkIGNvbWUgZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgaW4gcHJvZHVjdGlvblxyXG5jb25zdCBzZXJ2aWNlcyA9IHtcclxuICBhdXRoOiBwcm9jZXNzLmVudi5BVVRIX1NFUlZJQ0VfVVJMIHx8ICdodHRwOi8vbG9jYWxob3N0OjMwMDEnLFxyXG4gIHVzZXI6IHByb2Nlc3MuZW52LlVTRVJfU0VSVklDRV9VUkwgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMicsXHJcbiAgY29taWM6IHByb2Nlc3MuZW52LkNPTUlDX1NFUlZJQ0VfVVJMIHx8ICdodHRwOi8vbG9jYWxob3N0OjMwMDMnLFxyXG4gIHdhbGxldDogcHJvY2Vzcy5lbnYuV0FMTEVUX1NFUlZJQ0VfVVJMIHx8ICdodHRwOi8vbG9jYWxob3N0OjMwMDQnLFxyXG4gIGV2ZW50OiBwcm9jZXNzLmVudi5FVkVOVF9TRVJWSUNFX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDozMDA1JyxcclxuICBsZWRnZXI6IHByb2Nlc3MuZW52LkxFREdFUl9TRVJWSUNFX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDozMDA2JyxcclxufTtcclxuXHJcbi8vIEhlYWx0aCBjaGVjayBmb3IgdGhlIGdhdGV3YXkgaXRzZWxmXHJcbmFwcC5nZXQoXCIvaGVhbHRoXCIsIChyZXEsIHJlcykgPT4ge1xyXG4gIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgXHJcbiAgICBzdGF0dXM6IFwiaGVhbHRoeVwiLCBcclxuICAgIHNlcnZpY2U6IFwiYXBpLWdhdGV3YXlcIixcclxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgdXBzdHJlYW1TZXJ2aWNlczogc2VydmljZXNcclxuICB9KTtcclxufSk7XHJcblxyXG4vLyBSb3V0ZSByZXF1ZXN0cyB0byBhcHByb3ByaWF0ZSBtaWNyb3NlcnZpY2VzXHJcbmFwcC51c2UoJy9hdXRoJywgY3JlYXRlUHJveHlNaWRkbGV3YXJlKHtcclxuICB0YXJnZXQ6IHNlcnZpY2VzLmF1dGgsXHJcbiAgY2hhbmdlT3JpZ2luOiB0cnVlLFxyXG4gIHBhdGhSZXdyaXRlOiB7XHJcbiAgICAnXi9hdXRoJzogJy9hdXRoJ1xyXG4gIH0sXHJcbiAgb25FcnJvcjogKGVyciwgcmVxLCByZXMpID0+IHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0F1dGggU2VydmljZSBQcm94eSBFcnJvcjonLCBlcnIubWVzc2FnZSk7XHJcbiAgICAocmVzIGFzIGV4cHJlc3MuUmVzcG9uc2UpLnN0YXR1cyg1MDMpLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgZXJyb3I6ICdBdXRoIHNlcnZpY2UgdW5hdmFpbGFibGUnLFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgfSk7XHJcbiAgfVxyXG59KSk7XHJcblxyXG5hcHAudXNlKCcvdXNlcnMnLCBjcmVhdGVQcm94eU1pZGRsZXdhcmUoe1xyXG4gIHRhcmdldDogc2VydmljZXMudXNlcixcclxuICBjaGFuZ2VPcmlnaW46IHRydWUsXHJcbiAgcGF0aFJld3JpdGU6IHtcclxuICAgICdeL3VzZXJzJzogJy91c2VycydcclxuICB9LFxyXG4gIG9uRXJyb3I6IChlcnIsIHJlcSwgcmVzKSA9PiB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdVc2VyIFNlcnZpY2UgUHJveHkgRXJyb3I6JywgZXJyLm1lc3NhZ2UpO1xyXG4gICAgKHJlcyBhcyBleHByZXNzLlJlc3BvbnNlKS5zdGF0dXMoNTAzKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiAnVXNlciBzZXJ2aWNlIHVuYXZhaWxhYmxlJyxcclxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH0pO1xyXG4gIH1cclxufSkpO1xyXG5cclxuYXBwLnVzZSgnL2NvbWljcycsIGNyZWF0ZVByb3h5TWlkZGxld2FyZSh7XHJcbiAgdGFyZ2V0OiBzZXJ2aWNlcy5jb21pYyxcclxuICBjaGFuZ2VPcmlnaW46IHRydWUsXHJcbiAgcGF0aFJld3JpdGU6IHtcclxuICAgICdeL2NvbWljcyc6ICcvY29taWNzJ1xyXG4gIH0sXHJcbiAgb25FcnJvcjogKGVyciwgcmVxLCByZXMpID0+IHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0NvbWljIFNlcnZpY2UgUHJveHkgRXJyb3I6JywgZXJyLm1lc3NhZ2UpO1xyXG4gICAgKHJlcyBhcyBleHByZXNzLlJlc3BvbnNlKS5zdGF0dXMoNTAzKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiAnQ29taWMgc2VydmljZSB1bmF2YWlsYWJsZScsXHJcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICB9KTtcclxuICB9XHJcbn0pKTtcclxuXHJcbmFwcC51c2UoJy93YWxsZXQnLCBjcmVhdGVQcm94eU1pZGRsZXdhcmUoe1xyXG4gIHRhcmdldDogc2VydmljZXMud2FsbGV0LFxyXG4gIGNoYW5nZU9yaWdpbjogdHJ1ZSxcclxuICBwYXRoUmV3cml0ZToge1xyXG4gICAgJ14vd2FsbGV0JzogJy93YWxsZXQnXHJcbiAgfSxcclxuICBvbkVycm9yOiAoZXJyLCByZXEsIHJlcykgPT4ge1xyXG4gICAgY29uc29sZS5lcnJvcignV2FsbGV0IFNlcnZpY2UgUHJveHkgRXJyb3I6JywgZXJyLm1lc3NhZ2UpO1xyXG4gICAgKHJlcyBhcyBleHByZXNzLlJlc3BvbnNlKS5zdGF0dXMoNTAzKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiAnV2FsbGV0IHNlcnZpY2UgdW5hdmFpbGFibGUnLFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgfSk7XHJcbiAgfVxyXG59KSk7XHJcblxyXG5hcHAudXNlKCcvZXZlbnRzJywgY3JlYXRlUHJveHlNaWRkbGV3YXJlKHtcclxuICB0YXJnZXQ6IHNlcnZpY2VzLmV2ZW50LFxyXG4gIGNoYW5nZU9yaWdpbjogdHJ1ZSxcclxuICBwYXRoUmV3cml0ZToge1xyXG4gICAgJ14vZXZlbnRzJzogJy9ldmVudHMnXHJcbiAgfSxcclxuICBvbkVycm9yOiAoZXJyLCByZXEsIHJlcykgPT4ge1xyXG4gICAgY29uc29sZS5lcnJvcignRXZlbnQgU2VydmljZSBQcm94eSBFcnJvcjonLCBlcnIubWVzc2FnZSk7XHJcbiAgICAocmVzIGFzIGV4cHJlc3MuUmVzcG9uc2UpLnN0YXR1cyg1MDMpLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgZXJyb3I6ICdFdmVudCBzZXJ2aWNlIHVuYXZhaWxhYmxlJyxcclxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH0pO1xyXG4gIH1cclxufSkpO1xyXG5cclxuYXBwLnVzZSgnL2xlZGdlcicsIGNyZWF0ZVByb3h5TWlkZGxld2FyZSh7XHJcbiAgdGFyZ2V0OiBzZXJ2aWNlcy5sZWRnZXIsXHJcbiAgY2hhbmdlT3JpZ2luOiB0cnVlLFxyXG4gIHBhdGhSZXdyaXRlOiB7XHJcbiAgICAnXi9sZWRnZXInOiAnL2xlZGdlcidcclxuICB9LFxyXG4gIG9uRXJyb3I6IChlcnIsIHJlcSwgcmVzKSA9PiB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdMZWRnZXIgU2VydmljZSBQcm94eSBFcnJvcjonLCBlcnIubWVzc2FnZSk7XHJcbiAgICAocmVzIGFzIGV4cHJlc3MuUmVzcG9uc2UpLnN0YXR1cyg1MDMpLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgZXJyb3I6ICdMZWRnZXIgc2VydmljZSB1bmF2YWlsYWJsZScsXHJcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICB9KTtcclxuICB9XHJcbn0pKTtcclxuXHJcbmFwcC51c2UoZ2xvYmFsTm90Rm91bmRIYW5kbGVyKTtcclxuYXBwLnVzZShnbG9iYWxFcnJvckhhbmRsZXIpO1xyXG5cclxuY29uc3QgUE9SVCA9IHByb2Nlc3MuZW52LlBPUlQgfHwgMzAwMDtcclxuXHJcbmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgYXBwLmxpc3RlbihQT1JULCAoKSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZyhgQVBJIEdhdGV3YXkgcnVubmluZyBhdCBodHRwOi8vbG9jYWxob3N0OiR7UE9SVH1gKTtcclxuICAgIGNvbnNvbGUubG9nKCdSb3V0aW5nIHRvIHNlcnZpY2VzOicsIHNlcnZpY2VzKTtcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IHsgYXBwIH07Il19