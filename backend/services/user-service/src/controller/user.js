import { eq } from "drizzle-orm";
import { db } from "../config/db.js";
import { userProfiles } from "../model/profile.js";
import { authUsers } from "../model/auth.js";
export const getUserProfile = async (req, res) => {
    try {
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Unauthorized",
                timestamp: new Date().toISOString()
            });
        }
        const [profile] = await db
            .select({
            id: userProfiles.id,
            firstName: userProfiles.firstName,
            lastName: userProfiles.lastName,
            displayName: userProfiles.displayName,
            bio: userProfiles.bio,
            avatarUrl: userProfiles.avatarUrl,
            dateOfBirth: userProfiles.dateOfBirth,
            country: userProfiles.country,
            timezone: userProfiles.timezone,
            language: userProfiles.language,
            preferences: userProfiles.preferences,
            createdAt: userProfiles.createdAt,
            updatedAt: userProfiles.updatedAt,
            email: authUsers.email,
            username: authUsers.username,
        })
            .from(userProfiles)
            .innerJoin(authUsers, eq(userProfiles.authUserId, authUsers.id))
            .where(eq(authUsers.id, userId));
        if (!profile) {
            return res.status(404).json({
                success: false,
                error: "User profile not found",
                timestamp: new Date().toISOString()
            });
        }
        return res.status(200).json({
            success: true,
            data: profile,
            message: "User profile retrieved successfully"
        });
    }
    catch (error) {
        console.error("Get user profile error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
export const updateUserProfile = async (req, res) => {
    try {
        const userId = req.userId;
        const { firstName, lastName, displayName, bio, avatarUrl, dateOfBirth, country, timezone, language, preferences } = req.body;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Unauthorized",
                timestamp: new Date().toISOString()
            });
        }
        const [updatedProfile] = await db
            .update(userProfiles)
            .set({
            firstName,
            lastName,
            displayName,
            bio,
            avatarUrl,
            dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,
            country,
            timezone,
            language,
            preferences,
            updatedAt: new Date(),
        })
            .where(eq(userProfiles.authUserId, userId))
            .returning();
        if (!updatedProfile) {
            return res.status(404).json({
                success: false,
                error: "User profile not found",
                timestamp: new Date().toISOString()
            });
        }
        return res.status(200).json({
            success: true,
            data: updatedProfile,
            message: "User profile updated successfully"
        });
    }
    catch (error) {
        console.error("Update user profile error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
export const createUserProfile = async (req, res) => {
    try {
        const userId = req.userId;
        const { firstName, lastName, displayName, bio, avatarUrl, dateOfBirth, country, timezone, language = 'en', preferences = {} } = req.body;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Unauthorized",
                timestamp: new Date().toISOString()
            });
        }
        if (!displayName) {
            return res.status(400).json({
                success: false,
                error: "Display name is required",
                timestamp: new Date().toISOString()
            });
        }
        const [newProfile] = await db
            .insert(userProfiles)
            .values({
            authUserId: userId,
            firstName,
            lastName,
            displayName,
            bio,
            avatarUrl,
            dateOfBirth: dateOfBirth ? new Date(dateOfBirth) : null,
            country,
            timezone,
            language,
            preferences,
        })
            .returning();
        return res.status(201).json({
            success: true,
            data: newProfile,
            message: "User profile created successfully"
        });
    }
    catch (error) {
        console.error("Create user profile error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInVzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNqQyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDckMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUU3QyxNQUFNLENBQUMsTUFBTSxjQUFjLEdBQUcsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtJQUN6RCxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBRTFCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNaLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSxLQUFLO2dCQUNkLEtBQUssRUFBRSxjQUFjO2dCQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDcEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxNQUFNLEVBQUU7YUFDdkIsTUFBTSxDQUFDO1lBQ04sRUFBRSxFQUFFLFlBQVksQ0FBQyxFQUFFO1lBQ25CLFNBQVMsRUFBRSxZQUFZLENBQUMsU0FBUztZQUNqQyxRQUFRLEVBQUUsWUFBWSxDQUFDLFFBQVE7WUFDL0IsV0FBVyxFQUFFLFlBQVksQ0FBQyxXQUFXO1lBQ3JDLEdBQUcsRUFBRSxZQUFZLENBQUMsR0FBRztZQUNyQixTQUFTLEVBQUUsWUFBWSxDQUFDLFNBQVM7WUFDakMsV0FBVyxFQUFFLFlBQVksQ0FBQyxXQUFXO1lBQ3JDLE9BQU8sRUFBRSxZQUFZLENBQUMsT0FBTztZQUM3QixRQUFRLEVBQUUsWUFBWSxDQUFDLFFBQVE7WUFDL0IsUUFBUSxFQUFFLFlBQVksQ0FBQyxRQUFRO1lBQy9CLFdBQVcsRUFBRSxZQUFZLENBQUMsV0FBVztZQUNyQyxTQUFTLEVBQUUsWUFBWSxDQUFDLFNBQVM7WUFDakMsU0FBUyxFQUFFLFlBQVksQ0FBQyxTQUFTO1lBQ2pDLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSztZQUN0QixRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVE7U0FDN0IsQ0FBQzthQUNELElBQUksQ0FBQyxZQUFZLENBQUM7YUFDbEIsU0FBUyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDL0QsS0FBSyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFFbkMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2IsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLHdCQUF3QjtnQkFDL0IsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLE9BQU87WUFDYixPQUFPLEVBQUUscUNBQXFDO1NBQy9DLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSx1QkFBdUI7WUFDOUIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3BDLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBRyxLQUFLLEVBQUUsR0FBUSxFQUFFLEdBQVEsRUFBRSxFQUFFO0lBQzVELElBQUksQ0FBQztRQUNILE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDMUIsTUFBTSxFQUNKLFNBQVMsRUFDVCxRQUFRLEVBQ1IsV0FBVyxFQUNYLEdBQUcsRUFDSCxTQUFTLEVBQ1QsV0FBVyxFQUNYLE9BQU8sRUFDUCxRQUFRLEVBQ1IsUUFBUSxFQUNSLFdBQVcsRUFDWixHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFYixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMxQixPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsY0FBYztnQkFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsTUFBTSxFQUFFO2FBQzlCLE1BQU0sQ0FBQyxZQUFZLENBQUM7YUFDcEIsR0FBRyxDQUFDO1lBQ0gsU0FBUztZQUNULFFBQVE7WUFDUixXQUFXO1lBQ1gsR0FBRztZQUNILFNBQVM7WUFDVCxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUN2RCxPQUFPO1lBQ1AsUUFBUTtZQUNSLFFBQVE7WUFDUixXQUFXO1lBQ1gsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1NBQ3RCLENBQUM7YUFDRCxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDMUMsU0FBUyxFQUFFLENBQUM7UUFFZixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDcEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLHdCQUF3QjtnQkFDL0IsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLGNBQWM7WUFDcEIsT0FBTyxFQUFFLG1DQUFtQztTQUM3QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUIsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsdUJBQXVCO1lBQzlCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUcsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtJQUM1RCxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQzFCLE1BQU0sRUFDSixTQUFTLEVBQ1QsUUFBUSxFQUNSLFdBQVcsRUFDWCxHQUFHLEVBQ0gsU0FBUyxFQUNULFdBQVcsRUFDWCxPQUFPLEVBQ1AsUUFBUSxFQUNSLFFBQVEsR0FBRyxJQUFJLEVBQ2YsV0FBVyxHQUFHLEVBQUUsRUFDakIsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRWIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLGNBQWM7Z0JBQ3JCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTthQUNwQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSxLQUFLO2dCQUNkLEtBQUssRUFBRSwwQkFBMEI7Z0JBQ2pDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTthQUNwQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU0sRUFBRTthQUMxQixNQUFNLENBQUMsWUFBWSxDQUFDO2FBQ3BCLE1BQU0sQ0FBQztZQUNOLFVBQVUsRUFBRSxNQUFNO1lBQ2xCLFNBQVM7WUFDVCxRQUFRO1lBQ1IsV0FBVztZQUNYLEdBQUc7WUFDSCxTQUFTO1lBQ1QsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7WUFDdkQsT0FBTztZQUNQLFFBQVE7WUFDUixRQUFRO1lBQ1IsV0FBVztTQUNaLENBQUM7YUFDRCxTQUFTLEVBQUUsQ0FBQztRQUVmLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUIsT0FBTyxFQUFFLElBQUk7WUFDYixJQUFJLEVBQUUsVUFBVTtZQUNoQixPQUFPLEVBQUUsbUNBQW1DO1NBQzdDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSx1QkFBdUI7WUFDOUIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3BDLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcSB9IGZyb20gXCJkcml6emxlLW9ybVwiO1xuaW1wb3J0IHsgZGIgfSBmcm9tIFwiLi4vY29uZmlnL2RiLmpzXCI7XG5pbXBvcnQgeyB1c2VyUHJvZmlsZXMgfSBmcm9tIFwiLi4vbW9kZWwvcHJvZmlsZS5qc1wiO1xuaW1wb3J0IHsgYXV0aFVzZXJzIH0gZnJvbSBcIi4uL21vZGVsL2F1dGguanNcIjtcblxuZXhwb3J0IGNvbnN0IGdldFVzZXJQcm9maWxlID0gYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VySWQ7XG5cbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJVbmF1dGhvcml6ZWRcIixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IFtwcm9maWxlXSA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KHtcbiAgICAgICAgaWQ6IHVzZXJQcm9maWxlcy5pZCxcbiAgICAgICAgZmlyc3ROYW1lOiB1c2VyUHJvZmlsZXMuZmlyc3ROYW1lLFxuICAgICAgICBsYXN0TmFtZTogdXNlclByb2ZpbGVzLmxhc3ROYW1lLFxuICAgICAgICBkaXNwbGF5TmFtZTogdXNlclByb2ZpbGVzLmRpc3BsYXlOYW1lLFxuICAgICAgICBiaW86IHVzZXJQcm9maWxlcy5iaW8sXG4gICAgICAgIGF2YXRhclVybDogdXNlclByb2ZpbGVzLmF2YXRhclVybCxcbiAgICAgICAgZGF0ZU9mQmlydGg6IHVzZXJQcm9maWxlcy5kYXRlT2ZCaXJ0aCxcbiAgICAgICAgY291bnRyeTogdXNlclByb2ZpbGVzLmNvdW50cnksXG4gICAgICAgIHRpbWV6b25lOiB1c2VyUHJvZmlsZXMudGltZXpvbmUsXG4gICAgICAgIGxhbmd1YWdlOiB1c2VyUHJvZmlsZXMubGFuZ3VhZ2UsXG4gICAgICAgIHByZWZlcmVuY2VzOiB1c2VyUHJvZmlsZXMucHJlZmVyZW5jZXMsXG4gICAgICAgIGNyZWF0ZWRBdDogdXNlclByb2ZpbGVzLmNyZWF0ZWRBdCxcbiAgICAgICAgdXBkYXRlZEF0OiB1c2VyUHJvZmlsZXMudXBkYXRlZEF0LFxuICAgICAgICBlbWFpbDogYXV0aFVzZXJzLmVtYWlsLFxuICAgICAgICB1c2VybmFtZTogYXV0aFVzZXJzLnVzZXJuYW1lLFxuICAgICAgfSlcbiAgICAgIC5mcm9tKHVzZXJQcm9maWxlcylcbiAgICAgIC5pbm5lckpvaW4oYXV0aFVzZXJzLCBlcSh1c2VyUHJvZmlsZXMuYXV0aFVzZXJJZCwgYXV0aFVzZXJzLmlkKSlcbiAgICAgIC53aGVyZShlcShhdXRoVXNlcnMuaWQsIHVzZXJJZCkpO1xuXG4gICAgaWYgKCFwcm9maWxlKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBcIlVzZXIgcHJvZmlsZSBub3QgZm91bmRcIixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogcHJvZmlsZSxcbiAgICAgIG1lc3NhZ2U6IFwiVXNlciBwcm9maWxlIHJldHJpZXZlZCBzdWNjZXNzZnVsbHlcIlxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcihcIkdldCB1c2VyIHByb2ZpbGUgZXJyb3I6XCIsIGVycm9yKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IFwiSW50ZXJuYWwgc2VydmVyIGVycm9yXCIsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgIH0pO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgdXBkYXRlVXNlclByb2ZpbGUgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXJJZDtcbiAgICBjb25zdCB7XG4gICAgICBmaXJzdE5hbWUsXG4gICAgICBsYXN0TmFtZSxcbiAgICAgIGRpc3BsYXlOYW1lLFxuICAgICAgYmlvLFxuICAgICAgYXZhdGFyVXJsLFxuICAgICAgZGF0ZU9mQmlydGgsXG4gICAgICBjb3VudHJ5LFxuICAgICAgdGltZXpvbmUsXG4gICAgICBsYW5ndWFnZSxcbiAgICAgIHByZWZlcmVuY2VzXG4gICAgfSA9IHJlcS5ib2R5O1xuXG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IFxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IFwiVW5hdXRob3JpemVkXCIsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBbdXBkYXRlZFByb2ZpbGVdID0gYXdhaXQgZGJcbiAgICAgIC51cGRhdGUodXNlclByb2ZpbGVzKVxuICAgICAgLnNldCh7XG4gICAgICAgIGZpcnN0TmFtZSxcbiAgICAgICAgbGFzdE5hbWUsXG4gICAgICAgIGRpc3BsYXlOYW1lLFxuICAgICAgICBiaW8sXG4gICAgICAgIGF2YXRhclVybCxcbiAgICAgICAgZGF0ZU9mQmlydGg6IGRhdGVPZkJpcnRoID8gbmV3IERhdGUoZGF0ZU9mQmlydGgpIDogbnVsbCxcbiAgICAgICAgY291bnRyeSxcbiAgICAgICAgdGltZXpvbmUsXG4gICAgICAgIGxhbmd1YWdlLFxuICAgICAgICBwcmVmZXJlbmNlcyxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSlcbiAgICAgIC53aGVyZShlcSh1c2VyUHJvZmlsZXMuYXV0aFVzZXJJZCwgdXNlcklkKSlcbiAgICAgIC5yZXR1cm5pbmcoKTtcblxuICAgIGlmICghdXBkYXRlZFByb2ZpbGUpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IFxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IFwiVXNlciBwcm9maWxlIG5vdCBmb3VuZFwiLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB1cGRhdGVkUHJvZmlsZSxcbiAgICAgIG1lc3NhZ2U6IFwiVXNlciBwcm9maWxlIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5XCJcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJVcGRhdGUgdXNlciBwcm9maWxlIGVycm9yOlwiLCBlcnJvcik7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZVVzZXJQcm9maWxlID0gYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VySWQ7XG4gICAgY29uc3Qge1xuICAgICAgZmlyc3ROYW1lLFxuICAgICAgbGFzdE5hbWUsXG4gICAgICBkaXNwbGF5TmFtZSxcbiAgICAgIGJpbyxcbiAgICAgIGF2YXRhclVybCxcbiAgICAgIGRhdGVPZkJpcnRoLFxuICAgICAgY291bnRyeSxcbiAgICAgIHRpbWV6b25lLFxuICAgICAgbGFuZ3VhZ2UgPSAnZW4nLFxuICAgICAgcHJlZmVyZW5jZXMgPSB7fVxuICAgIH0gPSByZXEuYm9keTtcblxuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBcIlVuYXV0aG9yaXplZFwiLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCFkaXNwbGF5TmFtZSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJEaXNwbGF5IG5hbWUgaXMgcmVxdWlyZWRcIixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IFtuZXdQcm9maWxlXSA9IGF3YWl0IGRiXG4gICAgICAuaW5zZXJ0KHVzZXJQcm9maWxlcylcbiAgICAgIC52YWx1ZXMoe1xuICAgICAgICBhdXRoVXNlcklkOiB1c2VySWQsXG4gICAgICAgIGZpcnN0TmFtZSxcbiAgICAgICAgbGFzdE5hbWUsXG4gICAgICAgIGRpc3BsYXlOYW1lLFxuICAgICAgICBiaW8sXG4gICAgICAgIGF2YXRhclVybCxcbiAgICAgICAgZGF0ZU9mQmlydGg6IGRhdGVPZkJpcnRoID8gbmV3IERhdGUoZGF0ZU9mQmlydGgpIDogbnVsbCxcbiAgICAgICAgY291bnRyeSxcbiAgICAgICAgdGltZXpvbmUsXG4gICAgICAgIGxhbmd1YWdlLFxuICAgICAgICBwcmVmZXJlbmNlcyxcbiAgICAgIH0pXG4gICAgICAucmV0dXJuaW5nKCk7XG5cbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDEpLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IG5ld1Byb2ZpbGUsXG4gICAgICBtZXNzYWdlOiBcIlVzZXIgcHJvZmlsZSBjcmVhdGVkIHN1Y2Nlc3NmdWxseVwiXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKFwiQ3JlYXRlIHVzZXIgcHJvZmlsZSBlcnJvcjpcIiwgZXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IFxuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIixcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfSk7XG4gIH1cbn07Il19