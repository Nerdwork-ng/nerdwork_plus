import { eq, and, ilike } from "drizzle-orm";
import { db } from "../config/db.js";
import { userProfiles } from "../model/profile.js";
import { authUsers } from "../model/auth.js";
// Become a creator
export const becomeCreator = async (req, res) => {
    try {
        const userId = req.userId;
        const { creatorName, creatorBio, socialLinks } = req.body;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Authentication required",
                timestamp: new Date().toISOString()
            });
        }
        if (!creatorName) {
            return res.status(400).json({
                success: false,
                error: "Creator name is required",
                timestamp: new Date().toISOString()
            });
        }
        // Check if user already has a profile
        const [existingProfile] = await db
            .select()
            .from(userProfiles)
            .where(eq(userProfiles.authUserId, userId));
        if (!existingProfile) {
            return res.status(404).json({
                success: false,
                error: "User profile not found",
                timestamp: new Date().toISOString()
            });
        }
        if (existingProfile.isCreator) {
            return res.status(400).json({
                success: false,
                error: "User is already a creator",
                timestamp: new Date().toISOString()
            });
        }
        // Update profile to creator status
        const [updatedProfile] = await db
            .update(userProfiles)
            .set({
            isCreator: true,
            creatorName,
            creatorBio,
            socialLinks: socialLinks || {},
            updatedAt: new Date(),
        })
            .where(eq(userProfiles.authUserId, userId))
            .returning();
        return res.status(200).json({
            success: true,
            data: {
                id: updatedProfile.id,
                isCreator: updatedProfile.isCreator,
                creatorName: updatedProfile.creatorName,
                creatorBio: updatedProfile.creatorBio,
                socialLinks: updatedProfile.socialLinks,
                creatorVerified: updatedProfile.creatorVerified,
            },
            message: "Successfully became a creator"
        });
    }
    catch (error) {
        console.error("Become creator error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Update creator profile
export const updateCreatorProfile = async (req, res) => {
    try {
        const userId = req.userId;
        const { creatorName, creatorBio, socialLinks } = req.body;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Authentication required",
                timestamp: new Date().toISOString()
            });
        }
        // Check if user is a creator
        const [profile] = await db
            .select()
            .from(userProfiles)
            .where(eq(userProfiles.authUserId, userId));
        if (!profile || !profile.isCreator) {
            return res.status(403).json({
                success: false,
                error: "User is not a creator",
                timestamp: new Date().toISOString()
            });
        }
        // Update creator fields
        const updateData = { updatedAt: new Date() };
        if (creatorName !== undefined)
            updateData.creatorName = creatorName;
        if (creatorBio !== undefined)
            updateData.creatorBio = creatorBio;
        if (socialLinks !== undefined)
            updateData.socialLinks = socialLinks;
        const [updatedProfile] = await db
            .update(userProfiles)
            .set(updateData)
            .where(eq(userProfiles.authUserId, userId))
            .returning();
        return res.status(200).json({
            success: true,
            data: {
                id: updatedProfile.id,
                creatorName: updatedProfile.creatorName,
                creatorBio: updatedProfile.creatorBio,
                socialLinks: updatedProfile.socialLinks,
                creatorVerified: updatedProfile.creatorVerified,
            },
            message: "Creator profile updated successfully"
        });
    }
    catch (error) {
        console.error("Update creator profile error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Get creator profile (public)
export const getCreatorProfile = async (req, res) => {
    try {
        const { id } = req.params;
        const [creator] = await db
            .select({
            id: userProfiles.id,
            displayName: userProfiles.displayName,
            bio: userProfiles.bio,
            avatarUrl: userProfiles.avatarUrl,
            country: userProfiles.country,
            isCreator: userProfiles.isCreator,
            creatorName: userProfiles.creatorName,
            creatorBio: userProfiles.creatorBio,
            socialLinks: userProfiles.socialLinks,
            creatorVerified: userProfiles.creatorVerified,
            createdAt: userProfiles.createdAt,
            username: authUsers.username,
        })
            .from(userProfiles)
            .innerJoin(authUsers, eq(userProfiles.authUserId, authUsers.id))
            .where(and(eq(userProfiles.id, id), eq(userProfiles.isCreator, true)));
        if (!creator) {
            return res.status(404).json({
                success: false,
                error: "Creator not found",
                timestamp: new Date().toISOString()
            });
        }
        return res.status(200).json({
            success: true,
            data: creator,
            message: "Creator profile retrieved successfully"
        });
    }
    catch (error) {
        console.error("Get creator profile error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Browse creators
export const browseCreators = async (req, res) => {
    try {
        const { page = 1, limit = 20, search, country } = req.query;
        const offset = (parseInt(page) - 1) * parseInt(limit);
        let whereConditions = [eq(userProfiles.isCreator, true)];
        if (search) {
            whereConditions.push(ilike(userProfiles.creatorName, `%${search}%`));
        }
        if (country) {
            whereConditions.push(eq(userProfiles.country, country));
        }
        const creators = await db
            .select({
            id: userProfiles.id,
            displayName: userProfiles.displayName,
            avatarUrl: userProfiles.avatarUrl,
            country: userProfiles.country,
            creatorName: userProfiles.creatorName,
            creatorBio: userProfiles.creatorBio,
            creatorVerified: userProfiles.creatorVerified,
            createdAt: userProfiles.createdAt,
            username: authUsers.username,
        })
            .from(userProfiles)
            .innerJoin(authUsers, eq(userProfiles.authUserId, authUsers.id))
            .where(and(...whereConditions))
            .limit(parseInt(limit))
            .offset(offset);
        return res.status(200).json({
            success: true,
            data: {
                creators,
                pagination: {
                    page: parseInt(page),
                    limit: parseInt(limit),
                    hasMore: creators.length === parseInt(limit)
                }
            },
            message: "Creators retrieved successfully"
        });
    }
    catch (error) {
        console.error("Browse creators error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Check if user is creator
export const checkCreatorStatus = async (req, res) => {
    try {
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Authentication required",
                timestamp: new Date().toISOString()
            });
        }
        const [profile] = await db
            .select({
            isCreator: userProfiles.isCreator,
            creatorName: userProfiles.creatorName,
            creatorVerified: userProfiles.creatorVerified,
        })
            .from(userProfiles)
            .where(eq(userProfiles.authUserId, userId));
        if (!profile) {
            return res.status(404).json({
                success: false,
                error: "User profile not found",
                timestamp: new Date().toISOString()
            });
        }
        return res.status(200).json({
            success: true,
            data: {
                isCreator: profile.isCreator,
                creatorName: profile.creatorName,
                creatorVerified: profile.creatorVerified,
            },
            message: "Creator status retrieved successfully"
        });
    }
    catch (error) {
        console.error("Check creator status error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNyZWF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNyQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTdDLG1CQUFtQjtBQUNuQixNQUFNLENBQUMsTUFBTSxhQUFhLEdBQUcsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtJQUN4RCxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQzFCLE1BQU0sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFMUQsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLHlCQUF5QjtnQkFDaEMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLDBCQUEwQjtnQkFDakMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUM7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QztRQUNMLENBQUM7UUFFRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFO2dCQUNKLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUztnQkFDNUIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO2dCQUNoQyxlQUFlLEVBQUUsT0FBTyxDQUFDLGVBQWU7YUFDekM7WUFDRCxPQUFPLEVBQUUsdUNBQXVDO1NBQ2pELENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSx1QkFBdUI7WUFDOUIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3BDLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcSwgYW5kLCBpbGlrZSB9IGZyb20gXCJkcml6emxlLW9ybVwiO1xyXG5pbXBvcnQgeyBkYiB9IGZyb20gXCIuLi9jb25maWcvZGIuanNcIjtcclxuaW1wb3J0IHsgdXNlclByb2ZpbGVzIH0gZnJvbSBcIi4uL21vZGVsL3Byb2ZpbGUuanNcIjtcclxuaW1wb3J0IHsgYXV0aFVzZXJzIH0gZnJvbSBcIi4uL21vZGVsL2F1dGguanNcIjtcclxuXHJcbi8vIEJlY29tZSBhIGNyZWF0b3JcclxuZXhwb3J0IGNvbnN0IGJlY29tZUNyZWF0b3IgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VySWQ7XHJcbiAgICBjb25zdCB7IGNyZWF0b3JOYW1lLCBjcmVhdG9yQmlvLCBzb2NpYWxMaW5rcyB9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgaWYgKCF1c2VySWQpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiLFxyXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghY3JlYXRvck5hbWUpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogXCJDcmVhdG9yIG5hbWUgaXMgcmVxdWlyZWRcIixcclxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGVjayBpZiB1c2VyIGFscmVhZHkgaGFzIGEgcHJvZmlsZVxyXG4gICAgY29uc3QgW2V4aXN0aW5nUHJvZmlsZV0gPSBhd2FpdCBkYlxyXG4gICAgICAuc2VsZWN0KClcclxuICAgICAgLmZyb20odXNlclByb2ZpbGVzKVxyXG4gICAgICAud2hlcmUoZXEodXNlclByb2ZpbGVzLmF1dGhVc2VySWQsIHVzZXJJZCkpO1xyXG5cclxuICAgIGlmICghZXhpc3RpbmdQcm9maWxlKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6IFwiVXNlciBwcm9maWxlIG5vdCBmb3VuZFwiLFxyXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChleGlzdGluZ1Byb2ZpbGUuaXNDcmVhdG9yKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6IFwiVXNlciBpcyBhbHJlYWR5IGEgY3JlYXRvclwiLFxyXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVwZGF0ZSBwcm9maWxlIHRvIGNyZWF0b3Igc3RhdHVzXHJcbiAgICBjb25zdCBbdXBkYXRlZFByb2ZpbGVdID0gYXdhaXQgZGJcclxuICAgICAgLnVwZGF0ZSh1c2VyUHJvZmlsZXMpXHJcbiAgICAgIC5zZXQoe1xyXG4gICAgICAgIGlzQ3JlYXRvcjogdHJ1ZSxcclxuICAgICAgICBjcmVhdG9yTmFtZSxcclxuICAgICAgICBjcmVhdG9yQmlvLFxyXG4gICAgICAgIHNvY2lhbExpbmtzOiBzb2NpYWxMaW5rcyB8fCB7fSxcclxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgIH0pXHJcbiAgICAgIC53aGVyZShlcSh1c2VyUHJvZmlsZXMuYXV0aFVzZXJJZCwgdXNlcklkKSlcclxuICAgICAgLnJldHVybmluZygpO1xyXG5cclxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBpZDogdXBkYXRlZFByb2ZpbGUuaWQsXHJcbiAgICAgICAgaXNDcmVhdG9yOiB1cGRhdGVkUHJvZmlsZS5pc0NyZWF0b3IsXHJcbiAgICAgICAgY3JlYXRvck5hbWU6IHVwZGF0ZWRQcm9maWxlLmNyZWF0b3JOYW1lLFxyXG4gICAgICAgIGNyZWF0b3JCaW86IHVwZGF0ZWRQcm9maWxlLmNyZWF0b3JCaW8sXHJcbiAgICAgICAgc29jaWFsTGlua3M6IHVwZGF0ZWRQcm9maWxlLnNvY2lhbExpbmtzLFxyXG4gICAgICAgIGNyZWF0b3JWZXJpZmllZDogdXBkYXRlZFByb2ZpbGUuY3JlYXRvclZlcmlmaWVkLFxyXG4gICAgICB9LFxyXG4gICAgICBtZXNzYWdlOiBcIlN1Y2Nlc3NmdWxseSBiZWNhbWUgYSBjcmVhdG9yXCJcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJCZWNvbWUgY3JlYXRvciBlcnJvcjpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgfSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gVXBkYXRlIGNyZWF0b3IgcHJvZmlsZVxyXG5leHBvcnQgY29uc3QgdXBkYXRlQ3JlYXRvclByb2ZpbGUgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VySWQ7XHJcbiAgICBjb25zdCB7IGNyZWF0b3JOYW1lLCBjcmVhdG9yQmlvLCBzb2NpYWxMaW5rcyB9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgaWYgKCF1c2VySWQpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiLFxyXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYSBjcmVhdG9yXHJcbiAgICBjb25zdCBbcHJvZmlsZV0gPSBhd2FpdCBkYlxyXG4gICAgICAuc2VsZWN0KClcclxuICAgICAgLmZyb20odXNlclByb2ZpbGVzKVxyXG4gICAgICAud2hlcmUoZXEodXNlclByb2ZpbGVzLmF1dGhVc2VySWQsIHVzZXJJZCkpO1xyXG5cclxuICAgIGlmICghcHJvZmlsZSB8fCAhcHJvZmlsZS5pc0NyZWF0b3IpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogXCJVc2VyIGlzIG5vdCBhIGNyZWF0b3JcIixcclxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBVcGRhdGUgY3JlYXRvciBmaWVsZHNcclxuICAgIGNvbnN0IHVwZGF0ZURhdGE6IGFueSA9IHsgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpIH07XHJcbiAgICBpZiAoY3JlYXRvck5hbWUgIT09IHVuZGVmaW5lZCkgdXBkYXRlRGF0YS5jcmVhdG9yTmFtZSA9IGNyZWF0b3JOYW1lO1xyXG4gICAgaWYgKGNyZWF0b3JCaW8gIT09IHVuZGVmaW5lZCkgdXBkYXRlRGF0YS5jcmVhdG9yQmlvID0gY3JlYXRvckJpbztcclxuICAgIGlmIChzb2NpYWxMaW5rcyAhPT0gdW5kZWZpbmVkKSB1cGRhdGVEYXRhLnNvY2lhbExpbmtzID0gc29jaWFsTGlua3M7XHJcblxyXG4gICAgY29uc3QgW3VwZGF0ZWRQcm9maWxlXSA9IGF3YWl0IGRiXHJcbiAgICAgIC51cGRhdGUodXNlclByb2ZpbGVzKVxyXG4gICAgICAuc2V0KHVwZGF0ZURhdGEpXHJcbiAgICAgIC53aGVyZShlcSh1c2VyUHJvZmlsZXMuYXV0aFVzZXJJZCwgdXNlcklkKSlcclxuICAgICAgLnJldHVybmluZygpO1xyXG5cclxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBpZDogdXBkYXRlZFByb2ZpbGUuaWQsXHJcbiAgICAgICAgY3JlYXRvck5hbWU6IHVwZGF0ZWRQcm9maWxlLmNyZWF0b3JOYW1lLFxyXG4gICAgICAgIGNyZWF0b3JCaW86IHVwZGF0ZWRQcm9maWxlLmNyZWF0b3JCaW8sXHJcbiAgICAgICAgc29jaWFsTGlua3M6IHVwZGF0ZWRQcm9maWxlLnNvY2lhbExpbmtzLFxyXG4gICAgICAgIGNyZWF0b3JWZXJpZmllZDogdXBkYXRlZFByb2ZpbGUuY3JlYXRvclZlcmlmaWVkLFxyXG4gICAgICB9LFxyXG4gICAgICBtZXNzYWdlOiBcIkNyZWF0b3IgcHJvZmlsZSB1cGRhdGVkIHN1Y2Nlc3NmdWxseVwiXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiVXBkYXRlIGNyZWF0b3IgcHJvZmlsZSBlcnJvcjpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgfSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gR2V0IGNyZWF0b3IgcHJvZmlsZSAocHVibGljKVxyXG5leHBvcnQgY29uc3QgZ2V0Q3JlYXRvclByb2ZpbGUgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XHJcblxyXG4gICAgY29uc3QgW2NyZWF0b3JdID0gYXdhaXQgZGJcclxuICAgICAgLnNlbGVjdCh7XHJcbiAgICAgICAgaWQ6IHVzZXJQcm9maWxlcy5pZCxcclxuICAgICAgICBkaXNwbGF5TmFtZTogdXNlclByb2ZpbGVzLmRpc3BsYXlOYW1lLFxyXG4gICAgICAgIGJpbzogdXNlclByb2ZpbGVzLmJpbyxcclxuICAgICAgICBhdmF0YXJVcmw6IHVzZXJQcm9maWxlcy5hdmF0YXJVcmwsXHJcbiAgICAgICAgY291bnRyeTogdXNlclByb2ZpbGVzLmNvdW50cnksXHJcbiAgICAgICAgaXNDcmVhdG9yOiB1c2VyUHJvZmlsZXMuaXNDcmVhdG9yLFxyXG4gICAgICAgIGNyZWF0b3JOYW1lOiB1c2VyUHJvZmlsZXMuY3JlYXRvck5hbWUsXHJcbiAgICAgICAgY3JlYXRvckJpbzogdXNlclByb2ZpbGVzLmNyZWF0b3JCaW8sXHJcbiAgICAgICAgc29jaWFsTGlua3M6IHVzZXJQcm9maWxlcy5zb2NpYWxMaW5rcyxcclxuICAgICAgICBjcmVhdG9yVmVyaWZpZWQ6IHVzZXJQcm9maWxlcy5jcmVhdG9yVmVyaWZpZWQsXHJcbiAgICAgICAgY3JlYXRlZEF0OiB1c2VyUHJvZmlsZXMuY3JlYXRlZEF0LFxyXG4gICAgICAgIHVzZXJuYW1lOiBhdXRoVXNlcnMudXNlcm5hbWUsXHJcbiAgICAgIH0pXHJcbiAgICAgIC5mcm9tKHVzZXJQcm9maWxlcylcclxuICAgICAgLmlubmVySm9pbihhdXRoVXNlcnMsIGVxKHVzZXJQcm9maWxlcy5hdXRoVXNlcklkLCBhdXRoVXNlcnMuaWQpKVxyXG4gICAgICAud2hlcmUoYW5kKFxyXG4gICAgICAgIGVxKHVzZXJQcm9maWxlcy5pZCwgaWQpLCBcclxuICAgICAgICBlcSh1c2VyUHJvZmlsZXMuaXNDcmVhdG9yLCB0cnVlKVxyXG4gICAgICApKTtcclxuXHJcbiAgICBpZiAoIWNyZWF0b3IpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogXCJDcmVhdG9yIG5vdCBmb3VuZFwiLFxyXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIGRhdGE6IGNyZWF0b3IsXHJcbiAgICAgIG1lc3NhZ2U6IFwiQ3JlYXRvciBwcm9maWxlIHJldHJpZXZlZCBzdWNjZXNzZnVsbHlcIlxyXG4gICAgfSk7XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkdldCBjcmVhdG9yIHByb2ZpbGUgZXJyb3I6XCIsIGVycm9yKTtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBlcnJvcjogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIixcclxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH0pO1xyXG4gIH1cclxufTtcclxuXHJcbi8vIEJyb3dzZSBjcmVhdG9yc1xyXG5leHBvcnQgY29uc3QgYnJvd3NlQ3JlYXRvcnMgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHsgcGFnZSA9IDEsIGxpbWl0ID0gMjAsIHNlYXJjaCwgY291bnRyeSB9ID0gcmVxLnF1ZXJ5O1xyXG4gICAgY29uc3Qgb2Zmc2V0ID0gKHBhcnNlSW50KHBhZ2UpIC0gMSkgKiBwYXJzZUludChsaW1pdCk7XHJcblxyXG4gICAgbGV0IHdoZXJlQ29uZGl0aW9ucyA9IFtlcSh1c2VyUHJvZmlsZXMuaXNDcmVhdG9yLCB0cnVlKV07XHJcbiAgICBcclxuICAgIGlmIChzZWFyY2gpIHtcclxuICAgICAgd2hlcmVDb25kaXRpb25zLnB1c2goXHJcbiAgICAgICAgaWxpa2UodXNlclByb2ZpbGVzLmNyZWF0b3JOYW1lLCBgJSR7c2VhcmNofSVgKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAoY291bnRyeSkge1xyXG4gICAgICB3aGVyZUNvbmRpdGlvbnMucHVzaChlcSh1c2VyUHJvZmlsZXMuY291bnRyeSwgY291bnRyeSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNyZWF0b3JzID0gYXdhaXQgZGJcclxuICAgICAgLnNlbGVjdCh7XHJcbiAgICAgICAgaWQ6IHVzZXJQcm9maWxlcy5pZCxcclxuICAgICAgICBkaXNwbGF5TmFtZTogdXNlclByb2ZpbGVzLmRpc3BsYXlOYW1lLFxyXG4gICAgICAgIGF2YXRhclVybDogdXNlclByb2ZpbGVzLmF2YXRhclVybCxcclxuICAgICAgICBjb3VudHJ5OiB1c2VyUHJvZmlsZXMuY291bnRyeSxcclxuICAgICAgICBjcmVhdG9yTmFtZTogdXNlclByb2ZpbGVzLmNyZWF0b3JOYW1lLFxyXG4gICAgICAgIGNyZWF0b3JCaW86IHVzZXJQcm9maWxlcy5jcmVhdG9yQmlvLFxyXG4gICAgICAgIGNyZWF0b3JWZXJpZmllZDogdXNlclByb2ZpbGVzLmNyZWF0b3JWZXJpZmllZCxcclxuICAgICAgICBjcmVhdGVkQXQ6IHVzZXJQcm9maWxlcy5jcmVhdGVkQXQsXHJcbiAgICAgICAgdXNlcm5hbWU6IGF1dGhVc2Vycy51c2VybmFtZSxcclxuICAgICAgfSlcclxuICAgICAgLmZyb20odXNlclByb2ZpbGVzKVxyXG4gICAgICAuaW5uZXJKb2luKGF1dGhVc2VycywgZXEodXNlclByb2ZpbGVzLmF1dGhVc2VySWQsIGF1dGhVc2Vycy5pZCkpXHJcbiAgICAgIC53aGVyZShhbmQoLi4ud2hlcmVDb25kaXRpb25zKSlcclxuICAgICAgLmxpbWl0KHBhcnNlSW50KGxpbWl0KSlcclxuICAgICAgLm9mZnNldChvZmZzZXQpO1xyXG5cclxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBjcmVhdG9ycyxcclxuICAgICAgICBwYWdpbmF0aW9uOiB7XHJcbiAgICAgICAgICBwYWdlOiBwYXJzZUludChwYWdlKSxcclxuICAgICAgICAgIGxpbWl0OiBwYXJzZUludChsaW1pdCksXHJcbiAgICAgICAgICBoYXNNb3JlOiBjcmVhdG9ycy5sZW5ndGggPT09IHBhcnNlSW50KGxpbWl0KVxyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgbWVzc2FnZTogXCJDcmVhdG9ycyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5XCJcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJCcm93c2UgY3JlYXRvcnMgZXJyb3I6XCIsIGVycm9yKTtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBlcnJvcjogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIixcclxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH0pO1xyXG4gIH1cclxufTtcclxuXHJcbi8vIENoZWNrIGlmIHVzZXIgaXMgY3JlYXRvclxyXG5leHBvcnQgY29uc3QgY2hlY2tDcmVhdG9yU3RhdHVzID0gYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcklkO1xyXG5cclxuICAgIGlmICghdXNlcklkKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6IFwiQXV0aGVudGljYXRpb24gcmVxdWlyZWRcIixcclxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBbcHJvZmlsZV0gPSBhd2FpdCBkYlxyXG4gICAgICAuc2VsZWN0KHtcclxuICAgICAgICBpc0NyZWF0b3I6IHVzZXJQcm9maWxlcy5pc0NyZWF0b3IsXHJcbiAgICAgICAgY3JlYXRvck5hbWU6IHVzZXJQcm9maWxlcy5jcmVhdG9yTmFtZSxcclxuICAgICAgICBjcmVhdG9yVmVyaWZpZWQ6IHVzZXJQcm9maWxlcy5jcmVhdG9yVmVyaWZpZWQsXHJcbiAgICAgIH0pXHJcbiAgICAgIC5mcm9tKHVzZXJQcm9maWxlcylcclxuICAgICAgLndoZXJlKGVxKHVzZXJQcm9maWxlcy5hdXRoVXNlcklkLCB1c2VySWQpKTtcclxuXHJcbiAgICBpZiAoIXByb2ZpbGUpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogXCJVc2VyIHByb2ZpbGUgbm90IGZvdW5kXCIsXHJcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgZGF0YToge1xyXG4gICAgICAgIGlzQ3JlYXRvcjogcHJvZmlsZS5pc0NyZWF0b3IsXHJcbiAgICAgICAgY3JlYXRvck5hbWU6IHByb2ZpbGUuY3JlYXRvck5hbWUsXHJcbiAgICAgICAgY3JlYXRvclZlcmlmaWVkOiBwcm9maWxlLmNyZWF0b3JWZXJpZmllZCxcclxuICAgICAgfSxcclxuICAgICAgbWVzc2FnZTogXCJDcmVhdG9yIHN0YXR1cyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5XCJcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJDaGVjayBjcmVhdG9yIHN0YXR1cyBlcnJvcjpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIGVycm9yOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgfSk7XHJcbiAgfVxyXG59OyJdfQ==