import { eq, desc, asc, gte, lte, and, sql, ilike } from "drizzle-orm";
import { db } from "../config/db.js";
import { events, tickets, bookings, eventCategories, eventReviews } from "../model/event.js";
import { nanoid } from 'nanoid';
// Get all events with filtering and pagination
export const getEvents = async (req, res) => {
    try {
        const { page = 1, limit = 20, category, location, dateFrom, dateTo, search, featured, virtual, status = 'upcoming' } = req.query;
        const offset = (parseInt(page) - 1) * parseInt(limit);
        let whereConditions = [
            eq(events.isPublished, true),
            eq(events.status, status)
        ];
        if (category) {
            whereConditions.push(eq(events.category, category));
        }
        if (location) {
            whereConditions.push(ilike(events.city, `%${location}%`));
        }
        if (dateFrom) {
            whereConditions.push(gte(events.startDateTime, new Date(dateFrom)));
        }
        if (dateTo) {
            whereConditions.push(lte(events.startDateTime, new Date(dateTo)));
        }
        if (search) {
            whereConditions.push(sql `(${events.title} ILIKE ${`%${search}%`} OR ${events.description} ILIKE ${`%${search}%`})`);
        }
        if (featured === 'true') {
            whereConditions.push(eq(events.isFeatured, true));
        }
        if (virtual === 'true') {
            whereConditions.push(eq(events.isVirtual, true));
        }
        const eventsList = await db
            .select({
            id: events.id,
            title: events.title,
            shortDescription: events.shortDescription,
            category: events.category,
            organizer: events.organizer,
            venue: events.venue,
            city: events.city,
            state: events.state,
            country: events.country,
            startDateTime: events.startDateTime,
            endDateTime: events.endDateTime,
            coverImageUrl: events.coverImageUrl,
            isVirtual: events.isVirtual,
            isFeatured: events.isFeatured,
            currentAttendees: events.currentAttendees,
            maxAttendees: events.maxAttendees,
            status: events.status,
        })
            .from(events)
            .where(and(...whereConditions))
            .orderBy(desc(events.startDateTime))
            .limit(parseInt(limit))
            .offset(offset);
        const totalCount = await db
            .select({ count: sql `count(*)` })
            .from(events)
            .where(and(...whereConditions));
        return res.status(200).json({
            success: true,
            data: {
                events: eventsList,
                pagination: {
                    page: parseInt(page),
                    limit: parseInt(limit),
                    total: totalCount[0].count,
                    totalPages: Math.ceil(Number(totalCount[0].count) / parseInt(limit))
                }
            },
            message: "Events retrieved successfully"
        });
    }
    catch (error) {
        console.error("Get events error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Get specific event details with tickets
export const getEvent = async (req, res) => {
    try {
        const { id } = req.params;
        const [event] = await db
            .select()
            .from(events)
            .where(and(eq(events.id, id), eq(events.isPublished, true)));
        if (!event) {
            return res.status(404).json({
                success: false,
                error: "Event not found",
                timestamp: new Date().toISOString()
            });
        }
        // Get available tickets for this event
        const eventTickets = await db
            .select()
            .from(tickets)
            .where(and(eq(tickets.eventId, id), eq(tickets.isActive, true), gte(tickets.availableQuantity, 0)))
            .orderBy(asc(tickets.sortOrder));
        return res.status(200).json({
            success: true,
            data: {
                event,
                tickets: eventTickets
            },
            message: "Event retrieved successfully"
        });
    }
    catch (error) {
        console.error("Get event error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Book event tickets
export const bookTickets = async (req, res) => {
    try {
        const { id } = req.params;
        const { ticketId, quantity, attendeeInfo, paymentMethod } = req.body;
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Authentication required",
                timestamp: new Date().toISOString()
            });
        }
        // Get event and ticket details
        const [event] = await db
            .select()
            .from(events)
            .where(eq(events.id, id));
        const [ticket] = await db
            .select()
            .from(tickets)
            .where(and(eq(tickets.id, ticketId), eq(tickets.eventId, id)));
        if (!event || !ticket) {
            return res.status(404).json({
                success: false,
                error: "Event or ticket not found",
                timestamp: new Date().toISOString()
            });
        }
        // Check availability
        if (ticket.availableQuantity < quantity) {
            return res.status(400).json({
                success: false,
                error: "Insufficient tickets available",
                timestamp: new Date().toISOString()
            });
        }
        // Check quantity limits
        if (quantity < ticket.minQuantityPerOrder || quantity > ticket.maxQuantityPerOrder) {
            return res.status(400).json({
                success: false,
                error: `Quantity must be between ${ticket.minQuantityPerOrder} and ${ticket.maxQuantityPerOrder}`,
                timestamp: new Date().toISOString()
            });
        }
        // Calculate total price
        const totalPrice = (parseFloat(ticket.price) * quantity).toFixed(2);
        const bookingReference = `NW-${nanoid(10).toUpperCase()}`;
        // Create booking
        const [booking] = await db
            .insert(bookings)
            .values({
            userId,
            eventId: id,
            ticketId,
            quantity,
            totalPrice,
            paymentMethod,
            attendeeInfo,
            bookingReference,
            status: 'confirmed' // In real app, this would be 'pending' until payment
        })
            .returning();
        // Update ticket availability
        await db
            .update(tickets)
            .set({
            availableQuantity: ticket.availableQuantity - quantity,
            updatedAt: new Date()
        })
            .where(eq(tickets.id, ticketId));
        // Update event attendee count
        await db
            .update(events)
            .set({
            currentAttendees: event.currentAttendees + quantity,
            updatedAt: new Date()
        })
            .where(eq(events.id, id));
        return res.status(201).json({
            success: true,
            data: booking,
            message: "Tickets booked successfully"
        });
    }
    catch (error) {
        console.error("Book tickets error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Get user's bookings
export const getUserBookings = async (req, res) => {
    try {
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Authentication required",
                timestamp: new Date().toISOString()
            });
        }
        const userBookings = await db
            .select({
            id: bookings.id,
            quantity: bookings.quantity,
            totalPrice: bookings.totalPrice,
            status: bookings.status,
            bookingReference: bookings.bookingReference,
            checkInDateTime: bookings.checkInDateTime,
            createdAt: bookings.createdAt,
            event: {
                id: events.id,
                title: events.title,
                startDateTime: events.startDateTime,
                venue: events.venue,
                city: events.city,
                coverImageUrl: events.coverImageUrl,
            },
            ticket: {
                id: tickets.id,
                name: tickets.name,
                price: tickets.price,
            }
        })
            .from(bookings)
            .innerJoin(events, eq(bookings.eventId, events.id))
            .innerJoin(tickets, eq(bookings.ticketId, tickets.id))
            .where(eq(bookings.userId, userId))
            .orderBy(desc(bookings.createdAt));
        return res.status(200).json({
            success: true,
            data: userBookings,
            message: "Bookings retrieved successfully"
        });
    }
    catch (error) {
        console.error("Get user bookings error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Get event categories
export const getEventCategories = async (req, res) => {
    try {
        const categories = await db
            .select()
            .from(eventCategories)
            .where(eq(eventCategories.isActive, true))
            .orderBy(asc(eventCategories.sortOrder));
        return res.status(200).json({
            success: true,
            data: categories,
            message: "Event categories retrieved successfully"
        });
    }
    catch (error) {
        console.error("Get event categories error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
// Add event review
export const addEventReview = async (req, res) => {
    try {
        const { id } = req.params;
        const { rating, review } = req.body;
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({
                success: false,
                error: "Authentication required",
                timestamp: new Date().toISOString()
            });
        }
        if (!rating || rating < 1 || rating > 5) {
            return res.status(400).json({
                success: false,
                error: "Rating must be between 1 and 5",
                timestamp: new Date().toISOString()
            });
        }
        // Check if user attended the event
        const [booking] = await db
            .select()
            .from(bookings)
            .where(and(eq(bookings.userId, userId), eq(bookings.eventId, id), eq(bookings.status, 'confirmed')));
        if (!booking) {
            return res.status(403).json({
                success: false,
                error: "You can only review events you have attended",
                timestamp: new Date().toISOString()
            });
        }
        // Check if user already reviewed this event
        const [existingReview] = await db
            .select()
            .from(eventReviews)
            .where(and(eq(eventReviews.userId, userId), eq(eventReviews.eventId, id)));
        let reviewResult;
        if (existingReview) {
            [reviewResult] = await db
                .update(eventReviews)
                .set({
                rating,
                review,
                updatedAt: new Date(),
            })
                .where(eq(eventReviews.id, existingReview.id))
                .returning();
        }
        else {
            [reviewResult] = await db
                .insert(eventReviews)
                .values({
                userId,
                eventId: id,
                rating,
                review,
            })
                .returning();
        }
        return res.status(200).json({
            success: true,
            data: reviewResult,
            message: existingReview ? "Review updated successfully" : "Review added successfully"
        });
    }
    catch (error) {
        console.error("Add event review error:", error);
        return res.status(500).json({
            success: false,
            error: "Internal server error",
            timestamp: new Date().toISOString()
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN2RSxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDckMsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM3RixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRWhDLCtDQUErQztBQUMvQyxNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtJQUNwRCxJQUFJLENBQUM7UUFDSCxNQUFNLEVBQ0osSUFBSSxHQUFHLENBQUMsRUFDUixLQUFLLEdBQUcsRUFBRSxFQUNWLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxFQUNSLE1BQU0sRUFDTixNQUFNLEVBQ04sUUFBUSxFQUNSLE9BQU8sRUFDUCxNQUFNLEdBQUcsVUFBVSxFQUNwQixHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUM7UUFFZCxNQUFNLE1BQU0sR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdEQsSUFBSSxlQUFlLEdBQUc7WUFDcEIsRUFBRSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDO1lBQzVCLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztTQUMxQixDQUFDO1FBRUYsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNiLGVBQWUsQ0FBQyxJQUFJLENBQUMs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TUFBTTtnQkFDTixPQUFPLEVBQUUsRUFBRTtnQkFDWCxNQUFNO2dCQUNOLE1BQU07YUFDUCxDQUFDO2lCQUNELFNBQVMsRUFBRSxDQUFDO1FBQ2pCLENBQUM7UUFFRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLFlBQVk7WUFDbEIsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUMsNkJBQTZCLENBQUMsQ0FBQyxDQUFDLDJCQUEyQjtTQUN0RixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUIsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsdUJBQXVCO1lBQzlCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXEsIGRlc2MsIGFzYywgZ3RlLCBsdGUsIGFuZCwgc3FsLCBpbGlrZSB9IGZyb20gXCJkcml6emxlLW9ybVwiO1xuaW1wb3J0IHsgZGIgfSBmcm9tIFwiLi4vY29uZmlnL2RiLmpzXCI7XG5pbXBvcnQgeyBldmVudHMsIHRpY2tldHMsIGJvb2tpbmdzLCBldmVudENhdGVnb3JpZXMsIGV2ZW50UmV2aWV3cyB9IGZyb20gXCIuLi9tb2RlbC9ldmVudC5qc1wiO1xuaW1wb3J0IHsgbmFub2lkIH0gZnJvbSAnbmFub2lkJztcblxuLy8gR2V0IGFsbCBldmVudHMgd2l0aCBmaWx0ZXJpbmcgYW5kIHBhZ2luYXRpb25cbmV4cG9ydCBjb25zdCBnZXRFdmVudHMgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBcbiAgICAgIHBhZ2UgPSAxLCBcbiAgICAgIGxpbWl0ID0gMjAsIFxuICAgICAgY2F0ZWdvcnksIFxuICAgICAgbG9jYXRpb24sIFxuICAgICAgZGF0ZUZyb20sIFxuICAgICAgZGF0ZVRvLCBcbiAgICAgIHNlYXJjaCxcbiAgICAgIGZlYXR1cmVkLFxuICAgICAgdmlydHVhbCxcbiAgICAgIHN0YXR1cyA9ICd1cGNvbWluZydcbiAgICB9ID0gcmVxLnF1ZXJ5O1xuICAgIFxuICAgIGNvbnN0IG9mZnNldCA9IChwYXJzZUludChwYWdlKSAtIDEpICogcGFyc2VJbnQobGltaXQpO1xuXG4gICAgbGV0IHdoZXJlQ29uZGl0aW9ucyA9IFtcbiAgICAgIGVxKGV2ZW50cy5pc1B1Ymxpc2hlZCwgdHJ1ZSksXG4gICAgICBlcShldmVudHMuc3RhdHVzLCBzdGF0dXMpXG4gICAgXTtcbiAgICBcbiAgICBpZiAoY2F0ZWdvcnkpIHtcbiAgICAgIHdoZXJlQ29uZGl0aW9ucy5wdXNoKGVxKGV2ZW50cy5jYXRlZ29yeSwgY2F0ZWdvcnkpKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGxvY2F0aW9uKSB7XG4gICAgICB3aGVyZUNvbmRpdGlvbnMucHVzaChpbGlrZShldmVudHMuY2l0eSwgYCUke2xvY2F0aW9ufSVgKSk7XG4gICAgfVxuICAgIFxuICAgIGlmIChkYXRlRnJvbSkge1xuICAgICAgd2hlcmVDb25kaXRpb25zLnB1c2goZ3RlKGV2ZW50cy5zdGFydERhdGVUaW1lLCBuZXcgRGF0ZShkYXRlRnJvbSkpKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGRhdGVUbykge1xuICAgICAgd2hlcmVDb25kaXRpb25zLnB1c2gobHRlKGV2ZW50cy5zdGFydERhdGVUaW1lLCBuZXcgRGF0ZShkYXRlVG8pKSk7XG4gICAgfVxuICAgIFxuICAgIGlmIChzZWFyY2gpIHtcbiAgICAgIHdoZXJlQ29uZGl0aW9ucy5wdXNoKFxuICAgICAgICBzcWxgKCR7ZXZlbnRzLnRpdGxlfSBJTElLRSAke2AlJHtzZWFyY2h9JWB9IE9SICR7ZXZlbnRzLmRlc2NyaXB0aW9ufSBJTElLRSAke2AlJHtzZWFyY2h9JWB9KWBcbiAgICAgICk7XG4gICAgfVxuICAgIFxuICAgIGlmIChmZWF0dXJlZCA9PT0gJ3RydWUnKSB7XG4gICAgICB3aGVyZUNvbmRpdGlvbnMucHVzaChlcShldmVudHMuaXNGZWF0dXJlZCwgdHJ1ZSkpO1xuICAgIH1cbiAgICBcbiAgICBpZiAodmlydHVhbCA9PT0gJ3RydWUnKSB7XG4gICAgICB3aGVyZUNvbmRpdGlvbnMucHVzaChlcShldmVudHMuaXNWaXJ0dWFsLCB0cnVlKSk7XG4gICAgfVxuXG4gICAgY29uc3QgZXZlbnRzTGlzdCA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KHtcbiAgICAgICAgaWQ6IGV2ZW50cy5pZCxcbiAgICAgICAgdGl0bGU6IGV2ZW50cy50aXRsZSxcbiAgICAgICAgc2hvcnREZXNjcmlwdGlvbjogZXZlbnRzLnNob3J0RGVzY3JpcHRpb24sXG4gICAgICAgIGNhdGVnb3J5OiBldmVudHMuY2F0ZWdvcnksXG4gICAgICAgIG9yZ2FuaXplcjogZXZlbnRzLm9yZ2FuaXplcixcbiAgICAgICAgdmVudWU6IGV2ZW50cy52ZW51ZSxcbiAgICAgICAgY2l0eTogZXZlbnRzLmNpdHksXG4gICAgICAgIHN0YXRlOiBldmVudHMuc3RhdGUsXG4gICAgICAgIGNvdW50cnk6IGV2ZW50cy5jb3VudHJ5LFxuICAgICAgICBzdGFydERhdGVUaW1lOiBldmVudHMuc3RhcnREYXRlVGltZSxcbiAgICAgICAgZW5kRGF0ZVRpbWU6IGV2ZW50cy5lbmREYXRlVGltZSxcbiAgICAgICAgY292ZXJJbWFnZVVybDogZXZlbnRzLmNvdmVySW1hZ2VVcmwsXG4gICAgICAgIGlzVmlydHVhbDogZXZlbnRzLmlzVmlydHVhbCxcbiAgICAgICAgaXNGZWF0dXJlZDogZXZlbnRzLmlzRmVhdHVyZWQsXG4gICAgICAgIGN1cnJlbnRBdHRlbmRlZXM6IGV2ZW50cy5jdXJyZW50QXR0ZW5kZWVzLFxuICAgICAgICBtYXhBdHRlbmRlZXM6IGV2ZW50cy5tYXhBdHRlbmRlZXMsXG4gICAgICAgIHN0YXR1czogZXZlbnRzLnN0YXR1cyxcbiAgICAgIH0pXG4gICAgICAuZnJvbShldmVudHMpXG4gICAgICAud2hlcmUoYW5kKC4uLndoZXJlQ29uZGl0aW9ucykpXG4gICAgICAub3JkZXJCeShkZXNjKGV2ZW50cy5zdGFydERhdGVUaW1lKSlcbiAgICAgIC5saW1pdChwYXJzZUludChsaW1pdCkpXG4gICAgICAub2Zmc2V0KG9mZnNldCk7XG5cbiAgICBjb25zdCB0b3RhbENvdW50ID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoeyBjb3VudDogc3FsYGNvdW50KCopYCB9KVxuICAgICAgLmZyb20oZXZlbnRzKVxuICAgICAgLndoZXJlKGFuZCguLi53aGVyZUNvbmRpdGlvbnMpKTtcblxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBldmVudHM6IGV2ZW50c0xpc3QsXG4gICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICBwYWdlOiBwYXJzZUludChwYWdlKSxcbiAgICAgICAgICBsaW1pdDogcGFyc2VJbnQobGltaXQpLFxuICAgICAgICAgIHRvdGFsOiB0b3RhbENvdW50WzBdLmNvdW50LFxuICAgICAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbChOdW1iZXIodG90YWxDb3VudFswXS5jb3VudCkgLyBwYXJzZUludChsaW1pdCkpXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBtZXNzYWdlOiBcIkV2ZW50cyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5XCJcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJHZXQgZXZlbnRzIGVycm9yOlwiLCBlcnJvcik7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IFwiSW50ZXJuYWwgc2VydmVyIGVycm9yXCIsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgIH0pO1xuICB9XG59O1xuXG4vLyBHZXQgc3BlY2lmaWMgZXZlbnQgZGV0YWlscyB3aXRoIHRpY2tldHNcbmV4cG9ydCBjb25zdCBnZXRFdmVudCA9IGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuXG4gICAgY29uc3QgW2V2ZW50XSA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KClcbiAgICAgIC5mcm9tKGV2ZW50cylcbiAgICAgIC53aGVyZShhbmQoZXEoZXZlbnRzLmlkLCBpZCksIGVxKGV2ZW50cy5pc1B1Ymxpc2hlZCwgdHJ1ZSkpKTtcblxuICAgIGlmICghZXZlbnQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJFdmVudCBub3QgZm91bmRcIixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEdldCBhdmFpbGFibGUgdGlja2V0cyBmb3IgdGhpcyBldmVudFxuICAgIGNvbnN0IGV2ZW50VGlja2V0cyA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KClcbiAgICAgIC5mcm9tKHRpY2tldHMpXG4gICAgICAud2hlcmUoYW5kKFxuICAgICAgICBlcSh0aWNrZXRzLmV2ZW50SWQsIGlkKSxcbiAgICAgICAgZXEodGlja2V0cy5pc0FjdGl2ZSwgdHJ1ZSksXG4gICAgICAgIGd0ZSh0aWNrZXRzLmF2YWlsYWJsZVF1YW50aXR5LCAwKVxuICAgICAgKSlcbiAgICAgIC5vcmRlckJ5KGFzYyh0aWNrZXRzLnNvcnRPcmRlcikpO1xuXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGV2ZW50LFxuICAgICAgICB0aWNrZXRzOiBldmVudFRpY2tldHNcbiAgICAgIH0sXG4gICAgICBtZXNzYWdlOiBcIkV2ZW50IHJldHJpZXZlZCBzdWNjZXNzZnVsbHlcIlxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcihcIkdldCBldmVudCBlcnJvcjpcIiwgZXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gQm9vayBldmVudCB0aWNrZXRzXG5leHBvcnQgY29uc3QgYm9va1RpY2tldHMgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB7IHRpY2tldElkLCBxdWFudGl0eSwgYXR0ZW5kZWVJbmZvLCBwYXltZW50TWV0aG9kIH0gPSByZXEuYm9keTtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcklkO1xuXG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gR2V0IGV2ZW50IGFuZCB0aWNrZXQgZGV0YWlsc1xuICAgIGNvbnN0IFtldmVudF0gPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbShldmVudHMpXG4gICAgICAud2hlcmUoZXEoZXZlbnRzLmlkLCBpZCkpO1xuXG4gICAgY29uc3QgW3RpY2tldF0gPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbSh0aWNrZXRzKVxuICAgICAgLndoZXJlKGFuZChlcSh0aWNrZXRzLmlkLCB0aWNrZXRJZCksIGVxKHRpY2tldHMuZXZlbnRJZCwgaWQpKSk7XG5cbiAgICBpZiAoIWV2ZW50IHx8ICF0aWNrZXQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJFdmVudCBvciB0aWNrZXQgbm90IGZvdW5kXCIsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBhdmFpbGFiaWxpdHlcbiAgICBpZiAodGlja2V0LmF2YWlsYWJsZVF1YW50aXR5IDwgcXVhbnRpdHkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJJbnN1ZmZpY2llbnQgdGlja2V0cyBhdmFpbGFibGVcIixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHF1YW50aXR5IGxpbWl0c1xuICAgIGlmIChxdWFudGl0eSA8IHRpY2tldC5taW5RdWFudGl0eVBlck9yZGVyIHx8IHF1YW50aXR5ID4gdGlja2V0Lm1heFF1YW50aXR5UGVyT3JkZXIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogYFF1YW50aXR5IG11c3QgYmUgYmV0d2VlbiAke3RpY2tldC5taW5RdWFudGl0eVBlck9yZGVyfSBhbmQgJHt0aWNrZXQubWF4UXVhbnRpdHlQZXJPcmRlcn1gLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHRvdGFsIHByaWNlXG4gICAgY29uc3QgdG90YWxQcmljZSA9IChwYXJzZUZsb2F0KHRpY2tldC5wcmljZSkgKiBxdWFudGl0eSkudG9GaXhlZCgyKTtcbiAgICBjb25zdCBib29raW5nUmVmZXJlbmNlID0gYE5XLSR7bmFub2lkKDEwKS50b1VwcGVyQ2FzZSgpfWA7XG5cbiAgICAvLyBDcmVhdGUgYm9va2luZ1xuICAgIGNvbnN0IFtib29raW5nXSA9IGF3YWl0IGRiXG4gICAgICAuaW5zZXJ0KGJvb2tpbmdzKVxuICAgICAgLnZhbHVlcyh7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgZXZlbnRJZDogaWQsXG4gICAgICAgIHRpY2tldElkLFxuICAgICAgICBxdWFudGl0eSxcbiAgICAgICAgdG90YWxQcmljZSxcbiAgICAgICAgcGF5bWVudE1ldGhvZCxcbiAgICAgICAgYXR0ZW5kZWVJbmZvLFxuICAgICAgICBib29raW5nUmVmZXJlbmNlLFxuICAgICAgICBzdGF0dXM6ICdjb25maXJtZWQnIC8vIEluIHJlYWwgYXBwLCB0aGlzIHdvdWxkIGJlICdwZW5kaW5nJyB1bnRpbCBwYXltZW50XG4gICAgICB9KVxuICAgICAgLnJldHVybmluZygpO1xuXG4gICAgLy8gVXBkYXRlIHRpY2tldCBhdmFpbGFiaWxpdHlcbiAgICBhd2FpdCBkYlxuICAgICAgLnVwZGF0ZSh0aWNrZXRzKVxuICAgICAgLnNldCh7XG4gICAgICAgIGF2YWlsYWJsZVF1YW50aXR5OiB0aWNrZXQuYXZhaWxhYmxlUXVhbnRpdHkgLSBxdWFudGl0eSxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpXG4gICAgICB9KVxuICAgICAgLndoZXJlKGVxKHRpY2tldHMuaWQsIHRpY2tldElkKSk7XG5cbiAgICAvLyBVcGRhdGUgZXZlbnQgYXR0ZW5kZWUgY291bnRcbiAgICBhd2FpdCBkYlxuICAgICAgLnVwZGF0ZShldmVudHMpXG4gICAgICAuc2V0KHtcbiAgICAgICAgY3VycmVudEF0dGVuZGVlczogZXZlbnQuY3VycmVudEF0dGVuZGVlcyArIHF1YW50aXR5LFxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKClcbiAgICAgIH0pXG4gICAgICAud2hlcmUoZXEoZXZlbnRzLmlkLCBpZCkpO1xuXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiBib29raW5nLFxuICAgICAgbWVzc2FnZTogXCJUaWNrZXRzIGJvb2tlZCBzdWNjZXNzZnVsbHlcIlxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcihcIkJvb2sgdGlja2V0cyBlcnJvcjpcIiwgZXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gR2V0IHVzZXIncyBib29raW5nc1xuZXhwb3J0IGNvbnN0IGdldFVzZXJCb29raW5ncyA9IGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcklkO1xuXG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXNlckJvb2tpbmdzID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3Qoe1xuICAgICAgICBpZDogYm9va2luZ3MuaWQsXG4gICAgICAgIHF1YW50aXR5OiBib29raW5ncy5xdWFudGl0eSxcbiAgICAgICAgdG90YWxQcmljZTogYm9va2luZ3MudG90YWxQcmljZSxcbiAgICAgICAgc3RhdHVzOiBib29raW5ncy5zdGF0dXMsXG4gICAgICAgIGJvb2tpbmdSZWZlcmVuY2U6IGJvb2tpbmdzLmJvb2tpbmdSZWZlcmVuY2UsXG4gICAgICAgIGNoZWNrSW5EYXRlVGltZTogYm9va2luZ3MuY2hlY2tJbkRhdGVUaW1lLFxuICAgICAgICBjcmVhdGVkQXQ6IGJvb2tpbmdzLmNyZWF0ZWRBdCxcbiAgICAgICAgZXZlbnQ6IHtcbiAgICAgICAgICBpZDogZXZlbnRzLmlkLFxuICAgICAgICAgIHRpdGxlOiBldmVudHMudGl0bGUsXG4gICAgICAgICAgc3RhcnREYXRlVGltZTogZXZlbnRzLnN0YXJ0RGF0ZVRpbWUsXG4gICAgICAgICAgdmVudWU6IGV2ZW50cy52ZW51ZSxcbiAgICAgICAgICBjaXR5OiBldmVudHMuY2l0eSxcbiAgICAgICAgICBjb3ZlckltYWdlVXJsOiBldmVudHMuY292ZXJJbWFnZVVybCxcbiAgICAgICAgfSxcbiAgICAgICAgdGlja2V0OiB7XG4gICAgICAgICAgaWQ6IHRpY2tldHMuaWQsXG4gICAgICAgICAgbmFtZTogdGlja2V0cy5uYW1lLFxuICAgICAgICAgIHByaWNlOiB0aWNrZXRzLnByaWNlLFxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmZyb20oYm9va2luZ3MpXG4gICAgICAuaW5uZXJKb2luKGV2ZW50cywgZXEoYm9va2luZ3MuZXZlbnRJZCwgZXZlbnRzLmlkKSlcbiAgICAgIC5pbm5lckpvaW4odGlja2V0cywgZXEoYm9va2luZ3MudGlja2V0SWQsIHRpY2tldHMuaWQpKVxuICAgICAgLndoZXJlKGVxKGJvb2tpbmdzLnVzZXJJZCwgdXNlcklkKSlcbiAgICAgIC5vcmRlckJ5KGRlc2MoYm9va2luZ3MuY3JlYXRlZEF0KSk7XG5cbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHVzZXJCb29raW5ncyxcbiAgICAgIG1lc3NhZ2U6IFwiQm9va2luZ3MgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseVwiXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKFwiR2V0IHVzZXIgYm9va2luZ3MgZXJyb3I6XCIsIGVycm9yKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIixcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIEdldCBldmVudCBjYXRlZ29yaWVzXG5leHBvcnQgY29uc3QgZ2V0RXZlbnRDYXRlZ29yaWVzID0gYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNhdGVnb3JpZXMgPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbShldmVudENhdGVnb3JpZXMpXG4gICAgICAud2hlcmUoZXEoZXZlbnRDYXRlZ29yaWVzLmlzQWN0aXZlLCB0cnVlKSlcbiAgICAgIC5vcmRlckJ5KGFzYyhldmVudENhdGVnb3JpZXMuc29ydE9yZGVyKSk7XG5cbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IGNhdGVnb3JpZXMsXG4gICAgICBtZXNzYWdlOiBcIkV2ZW50IGNhdGVnb3JpZXMgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseVwiXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKFwiR2V0IGV2ZW50IGNhdGVnb3JpZXMgZXJyb3I6XCIsIGVycm9yKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIixcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIEFkZCBldmVudCByZXZpZXdcbmV4cG9ydCBjb25zdCBhZGRFdmVudFJldmlldyA9IGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHsgcmF0aW5nLCByZXZpZXcgfSA9IHJlcS5ib2R5O1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VySWQ7XG5cbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBcIkF1dGhlbnRpY2F0aW9uIHJlcXVpcmVkXCIsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoIXJhdGluZyB8fCByYXRpbmcgPCAxIHx8IHJhdGluZyA+IDUpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogXCJSYXRpbmcgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDVcIixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgYXR0ZW5kZWQgdGhlIGV2ZW50XG4gICAgY29uc3QgW2Jvb2tpbmddID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoKVxuICAgICAgLmZyb20oYm9va2luZ3MpXG4gICAgICAud2hlcmUoYW5kKFxuICAgICAgICBlcShib29raW5ncy51c2VySWQsIHVzZXJJZCksXG4gICAgICAgIGVxKGJvb2tpbmdzLmV2ZW50SWQsIGlkKSxcbiAgICAgICAgZXEoYm9va2luZ3Muc3RhdHVzLCAnY29uZmlybWVkJylcbiAgICAgICkpO1xuXG4gICAgaWYgKCFib29raW5nKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IFwiWW91IGNhbiBvbmx5IHJldmlldyBldmVudHMgeW91IGhhdmUgYXR0ZW5kZWRcIixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgYWxyZWFkeSByZXZpZXdlZCB0aGlzIGV2ZW50XG4gICAgY29uc3QgW2V4aXN0aW5nUmV2aWV3XSA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KClcbiAgICAgIC5mcm9tKGV2ZW50UmV2aWV3cylcbiAgICAgIC53aGVyZShhbmQoZXEoZXZlbnRSZXZpZXdzLnVzZXJJZCwgdXNlcklkKSwgZXEoZXZlbnRSZXZpZXdzLmV2ZW50SWQsIGlkKSkpO1xuXG4gICAgbGV0IHJldmlld1Jlc3VsdDtcbiAgICBpZiAoZXhpc3RpbmdSZXZpZXcpIHtcbiAgICAgIFtyZXZpZXdSZXN1bHRdID0gYXdhaXQgZGJcbiAgICAgICAgLnVwZGF0ZShldmVudFJldmlld3MpXG4gICAgICAgIC5zZXQoe1xuICAgICAgICAgIHJhdGluZyxcbiAgICAgICAgICByZXZpZXcsXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9KVxuICAgICAgICAud2hlcmUoZXEoZXZlbnRSZXZpZXdzLmlkLCBleGlzdGluZ1Jldmlldy5pZCkpXG4gICAgICAgIC5yZXR1cm5pbmcoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgW3Jldmlld1Jlc3VsdF0gPSBhd2FpdCBkYlxuICAgICAgICAuaW5zZXJ0KGV2ZW50UmV2aWV3cylcbiAgICAgICAgLnZhbHVlcyh7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIGV2ZW50SWQ6IGlkLFxuICAgICAgICAgIHJhdGluZyxcbiAgICAgICAgICByZXZpZXcsXG4gICAgICAgIH0pXG4gICAgICAgIC5yZXR1cm5pbmcoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHJldmlld1Jlc3VsdCxcbiAgICAgIG1lc3NhZ2U6IGV4aXN0aW5nUmV2aWV3ID8gXCJSZXZpZXcgdXBkYXRlZCBzdWNjZXNzZnVsbHlcIiA6IFwiUmV2aWV3IGFkZGVkIHN1Y2Nlc3NmdWxseVwiXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKFwiQWRkIGV2ZW50IHJldmlldyBlcnJvcjpcIiwgZXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcbiAgfVxufTsiXX0=