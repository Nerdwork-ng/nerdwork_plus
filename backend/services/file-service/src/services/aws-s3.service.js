import { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand, HeadObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
class AWSS3Service {
    s3Client;
    config;
    constructor(config) {
        this.config = config;
        this.s3Client = new S3Client({
            region: config.region,
            credentials: {
                accessKeyId: config.accessKeyId,
                secretAccessKey: config.secretAccessKey,
            },
        });
    }
    async uploadFile(fileBuffer, key, contentType, options) {
        try {
            const command = new PutObjectCommand({
                Bucket: this.config.bucketName,
                Key: key,
                Body: fileBuffer,
                ContentType: contentType || 'application/octet-stream',
                Metadata: options?.metadata,
                ACL: options?.acl || 'public-read',
                CacheControl: options?.cacheControl || 'max-age=31536000', // 1 year default
            });
            await this.s3Client.send(command);
            const location = `https://${this.config.bucketName}.s3.${this.config.region}.amazonaws.com/${key}`;
            const cdnUrl = this.config.cloudFrontDomain ?
                `https://${this.config.cloudFrontDomain}/${key}` :
                location;
            return {
                key,
                bucket: this.config.bucketName,
                location,
                cdnUrl,
                size: fileBuffer.length,
                contentType: contentType || 'application/octet-stream',
            };
        }
        catch (error) {
            console.error('S3 upload error:', error.message);
            throw new Error(`Failed to upload file to S3: ${error.message}`);
        }
    }
    async getPresignedUploadUrl(key, contentType, expiresIn = 3600 // 1 hour default
    ) {
        try {
            const command = new PutObjectCommand({
                Bucket: this.config.bucketName,
                Key: key,
                ContentType: contentType,
                ACL: 'public-read',
            });
            const uploadUrl = await getSignedUrl(this.s3Client, command, { expiresIn });
            return {
                uploadUrl,
                key,
                expiresIn,
            };
        }
        catch (error) {
            console.error('S3 presigned URL error:', error.message);
            throw new Error(`Failed to generate presigned URL: ${error.message}`);
        }
    }
    async getPresignedDownloadUrl(key, expiresIn = 3600) {
        try {
            const command = new GetObjectCommand({
                Bucket: this.config.bucketName,
                Key: key,
            });
            return await getSignedUrl(this.s3Client, command, { expiresIn });
        }
        catch (error) {
            console.error('S3 presigned download URL error:', error.message);
            throw new Error(`Failed to generate presigned download URL: ${error.message}`);
        }
    }
    async deleteFile(key) {
        try {
            const command = new DeleteObjectCommand({
                Bucket: this.config.bucketName,
                Key: key,
            });
            await this.s3Client.send(command);
        }
        catch (error) {
            console.error('S3 delete error:', error.message);
            throw new Error(`Failed to delete file from S3: ${error.message}`);
        }
    }
    async getFileMetadata(key) {
        try {
            const command = new HeadObjectCommand({
                Bucket: this.config.bucketName,
                Key: key,
            });
            const response = await this.s3Client.send(command);
            return {
                size: response.ContentLength,
                contentType: response.ContentType,
                lastModified: response.LastModified,
                metadata: response.Metadata,
                etag: response.ETag,
            };
        }
        catch (error) {
            console.error('S3 head object error:', error.message);
            throw new Error(`Failed to get file metadata: ${error.message}`);
        }
    }
    generateKey(prefix, filename, userId) {
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 15);
        const sanitizedFilename = filename.replace(/[^a-zA-Z0-9.-]/g, '_');
        if (userId) {
            return `${prefix}/${userId}/${timestamp}_${random}_${sanitizedFilename}`;
        }
        return `${prefix}/${timestamp}_${random}_${sanitizedFilename}`;
    }
    getPublicUrl(key) {
        if (this.config.cloudFrontDomain) {
            return `https://${this.config.cloudFrontDomain}/${key}`;
        }
        return `https://${this.config.bucketName}.s3.${this.config.region}.amazonaws.com/${key}`;
    }
}
export default AWSS3Service;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLXMzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhd3MtczMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDMUgsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBeUI3RCxNQUFNLFlBQVk7SUFDUixRQUFRLENBQVc7SUFDbkIsTUFBTSxDQUFXO0lBRXpCLFlBQVksTUFBZ0I7UUFDMUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQztZQUMzQixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU07WUFDckIsV0FBVyxFQUFFO2dCQUNYLFdBQVcsRUFBRSxNQUFNLENBQUMsV0FBVztnQkFDL0IsZUFBZSxFQUFFLE1BQU0sQ0FBQyxlQUFlO2FBQ3hDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQ2QsVUFBa0IsRUFDbEIsR0FBVyxFQUNYLFdBQW9CLEVBQ3BCLE9BSUM7UUFFRCxJQUFJLENBQUM7WUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLGdCQUFnQixDQUFDO2dCQUNuQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVO2dCQUM5QixHQUFHLEVBQUUsR0FBRztnQkFDUixJQUFJLEVBQUUsVUFBVTtnQkFDaEIsV0FBVyxFQUFFLFdBQVcsSUFBSSwwQkFBMEI7Z0JBQ3RELFFBQVEsRUFBRSxPQUFPLEVBQUUsUUFBUTtnQkFDM0IsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksYUFBYTtnQkFDbEMsWUFBWSxFQUFFLE9BQU8sRUFBRSxZQUFZLElBQUksa0JBQWtCLEVBQUUsaUJBQWlCO2FBQzdFLENBQUMsQ0FBQztZQUVILE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFbEMsTUFBTSxRQUFRLEdBQUcsV0FBVyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sa0JBQWtCLEdBQUcsRUFBRSxDQUFDO1lBQ25HLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztnQkFDM0MsV0FBVyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ2xELFFBQVEsQ0FBQztZQUVYLE9BQU87Z0JBQ0wsR0FBRztnQkFDSCxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVO2dCQUM5QixRQUFRO2dCQUNSLE1BQU07Z0JBQ04sSUFBSSxFQUFFLFVBQVUsQ0FBQyxNQUFNO2dCQUN2QixXQUFXLEVBQUUsV0FBVyxJQUFJLDBCQUEwQjthQUN2RCxDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakQsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMscUJBQXFCLENBQ3pCLEdBQVcsRUFDWCxXQUFtQixFQUNuQixZQUFvQixJQUFJLENBQUMsaUJBQWlCOztRQUUxQyxJQUFJLENBQUM7WUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLGdCQUFnQixDQUFDO2dCQUNuQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVO2dCQUM5QixHQUFHLEVBQUUsR0FBRztnQkFDUixXQUFXLEVBQUUsV0FBVztnQkFDeEIsR0FBRyxFQUFFLGFBQWE7YUFDbkIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxTQUFTLEdBQUcsTUFBTSxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBRTVFLE9BQU87Z0JBQ0wsU0FBUztnQkFDVCxHQUFHO2dCQUNILFNBQVM7YUFDVixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDeEQsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBcUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDeEUsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsdUJBQXVCLENBQzNCLEdBQVcsRUFDWCxZQUFvQixJQUFJO1FBRXhCLElBQUksQ0FBQztZQUNILE1BQU0sT0FBTyxHQUFHLElBQUksZ0JBQWdCLENBQUM7Z0JBQ25DLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7Z0JBQzlCLEdBQUcsRUFBRSxHQUFHO2FBQ1QsQ0FBQyxDQUFDO1lBRUgsT0FBTyxNQUFNLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakUsTUFBTSxJQUFJLEtBQUssQ0FBQyw4Q0FBOEMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDakYsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUFDLEdBQVc7UUFDMUIsSUFBSSxDQUFDO1lBQ0gsTUFBTSxPQUFPLEdBQUcsSUFBSSxtQkFBbUIsQ0FBQztnQkFDdEMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVTtnQkFDOUIsR0FBRyxFQUFFLEdBQUc7YUFDVCxDQUFDLENBQUM7WUFFSCxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2pELE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBQyxHQUFXO1FBQy9CLElBQUksQ0FBQztZQUNILE1BQU0sT0FBTyxHQUFHLElBQUksaUJBQWlCLENBQUM7Z0JBQ3BDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7Z0JBQzlCLEdBQUcsRUFBRSxHQUFHO2FBQ1QsQ0FBQyxDQUFDO1lBRUgsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVuRCxPQUFPO2dCQUNMLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYTtnQkFDNUIsV0FBVyxFQUFFLFFBQVEsQ0FBQyxXQUFXO2dCQUNqQyxZQUFZLEVBQUUsUUFBUSxDQUFDLFlBQVk7Z0JBQ25DLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTtnQkFDM0IsSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJO2FBQ3BCLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN0RCxNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUNuRSxDQUFDO0lBQ0gsQ0FBQztJQUVELFdBQVcsQ0FBQyxNQUFjLEVBQUUsUUFBZ0IsRUFBRSxNQUFlO1FBQzNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0QsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRW5FLElBQUksTUFBTSxFQUFFLENBQUM7WUFDWCxPQUFPLEdBQUcsTUFBTSxJQUFJLE1BQU0sSUFBSSxTQUFTLElBQUksTUFBTSxJQUFJLGlCQUFpQixFQUFFLENBQUM7UUFDM0UsQ0FBQztRQUVELE9BQU8sR0FBRyxNQUFNLElBQUksU0FBUyxJQUFJLE1BQU0sSUFBSSxpQkFBaUIsRUFBRSxDQUFDO0lBQ2pFLENBQUM7SUFFRCxZQUFZLENBQUMsR0FBVztRQUN0QixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNqQyxPQUFPLFdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMxRCxDQUFDO1FBQ0QsT0FBTyxXQUFXLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxFQUFFLENBQUM7SUFDM0YsQ0FBQztDQUNGO0FBRUQsZUFBZSxZQUFZLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTM0NsaWVudCwgUHV0T2JqZWN0Q29tbWFuZCwgR2V0T2JqZWN0Q29tbWFuZCwgRGVsZXRlT2JqZWN0Q29tbWFuZCwgSGVhZE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xyXG5pbXBvcnQgeyBnZXRTaWduZWRVcmwgfSBmcm9tICdAYXdzLXNkay9zMy1yZXF1ZXN0LXByZXNpZ25lcic7XHJcblxyXG5pbnRlcmZhY2UgUzNDb25maWcge1xyXG4gIHJlZ2lvbjogc3RyaW5nO1xyXG4gIGFjY2Vzc0tleUlkOiBzdHJpbmc7XHJcbiAgc2VjcmV0QWNjZXNzS2V5OiBzdHJpbmc7XHJcbiAgYnVja2V0TmFtZTogc3RyaW5nO1xyXG4gIGNsb3VkRnJvbnREb21haW4/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBTM1VwbG9hZFJlc3BvbnNlIHtcclxuICBrZXk6IHN0cmluZztcclxuICBidWNrZXQ6IHN0cmluZztcclxuICBsb2NhdGlvbjogc3RyaW5nO1xyXG4gIGNkblVybD86IHN0cmluZztcclxuICBzaXplPzogbnVtYmVyO1xyXG4gIGNvbnRlbnRUeXBlPzogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgUzNQcmVzaWduZWRVcmxSZXNwb25zZSB7XHJcbiAgdXBsb2FkVXJsOiBzdHJpbmc7XHJcbiAga2V5OiBzdHJpbmc7XHJcbiAgZXhwaXJlc0luOiBudW1iZXI7XHJcbn1cclxuXHJcbmNsYXNzIEFXU1MzU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzM0NsaWVudDogUzNDbGllbnQ7XHJcbiAgcHJpdmF0ZSBjb25maWc6IFMzQ29uZmlnO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFMzQ29uZmlnKSB7XHJcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcclxuICAgIHRoaXMuczNDbGllbnQgPSBuZXcgUzNDbGllbnQoe1xyXG4gICAgICByZWdpb246IGNvbmZpZy5yZWdpb24sXHJcbiAgICAgIGNyZWRlbnRpYWxzOiB7XHJcbiAgICAgICAgYWNjZXNzS2V5SWQ6IGNvbmZpZy5hY2Nlc3NLZXlJZCxcclxuICAgICAgICBzZWNyZXRBY2Nlc3NLZXk6IGNvbmZpZy5zZWNyZXRBY2Nlc3NLZXksXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHVwbG9hZEZpbGUoXHJcbiAgICBmaWxlQnVmZmVyOiBCdWZmZXIsIFxyXG4gICAga2V5OiBzdHJpbmcsIFxyXG4gICAgY29udGVudFR5cGU/OiBzdHJpbmcsXHJcbiAgICBvcHRpb25zPzoge1xyXG4gICAgICBtZXRhZGF0YT86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XHJcbiAgICAgIGFjbD86ICdwcml2YXRlJyB8ICdwdWJsaWMtcmVhZCcgfCAncHVibGljLXJlYWQtd3JpdGUnO1xyXG4gICAgICBjYWNoZUNvbnRyb2w/OiBzdHJpbmc7XHJcbiAgICB9XHJcbiAgKTogUHJvbWlzZTxTM1VwbG9hZFJlc3BvbnNlPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBjb21tYW5kID0gbmV3IFB1dE9iamVjdENvbW1hbmQoe1xyXG4gICAgICAgIEJ1Y2tldDogdGhpcy5jb25maWcuYnVja2V0TmFtZSxcclxuICAgICAgICBLZXk6IGtleSxcclxuICAgICAgICBCb2R5OiBmaWxlQnVmZmVyLFxyXG4gICAgICAgIENvbnRlbnRUeXBlOiBjb250ZW50VHlwZSB8fCAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcclxuICAgICAgICBNZXRhZGF0YTogb3B0aW9ucz8ubWV0YWRhdGEsXHJcbiAgICAgICAgQUNMOiBvcHRpb25zPy5hY2wgfHwgJ3B1YmxpYy1yZWFkJyxcclxuICAgICAgICBDYWNoZUNvbnRyb2w6IG9wdGlvbnM/LmNhY2hlQ29udHJvbCB8fCAnbWF4LWFnZT0zMTUzNjAwMCcsIC8vIDEgeWVhciBkZWZhdWx0XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgYXdhaXQgdGhpcy5zM0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICAgICAgY29uc3QgbG9jYXRpb24gPSBgaHR0cHM6Ly8ke3RoaXMuY29uZmlnLmJ1Y2tldE5hbWV9LnMzLiR7dGhpcy5jb25maWcucmVnaW9ufS5hbWF6b25hd3MuY29tLyR7a2V5fWA7XHJcbiAgICAgIGNvbnN0IGNkblVybCA9IHRoaXMuY29uZmlnLmNsb3VkRnJvbnREb21haW4gPyBcclxuICAgICAgICBgaHR0cHM6Ly8ke3RoaXMuY29uZmlnLmNsb3VkRnJvbnREb21haW59LyR7a2V5fWAgOiBcclxuICAgICAgICBsb2NhdGlvbjtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAga2V5LFxyXG4gICAgICAgIGJ1Y2tldDogdGhpcy5jb25maWcuYnVja2V0TmFtZSxcclxuICAgICAgICBsb2NhdGlvbixcclxuICAgICAgICBjZG5VcmwsXHJcbiAgICAgICAgc2l6ZTogZmlsZUJ1ZmZlci5sZW5ndGgsXHJcbiAgICAgICAgY29udGVudFR5cGU6IGNvbnRlbnRUeXBlIHx8ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdTMyB1cGxvYWQgZXJyb3I6JywgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHVwbG9hZCBmaWxlIHRvIFMzOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRQcmVzaWduZWRVcGxvYWRVcmwoXHJcbiAgICBrZXk6IHN0cmluZywgXHJcbiAgICBjb250ZW50VHlwZTogc3RyaW5nLFxyXG4gICAgZXhwaXJlc0luOiBudW1iZXIgPSAzNjAwIC8vIDEgaG91ciBkZWZhdWx0XHJcbiAgKTogUHJvbWlzZTxTM1ByZXNpZ25lZFVybFJlc3BvbnNlPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBjb21tYW5kID0gbmV3IFB1dE9iamVjdENvbW1hbmQoe1xyXG4gICAgICAgIEJ1Y2tldDogdGhpcy5jb25maWcuYnVja2V0TmFtZSxcclxuICAgICAgICBLZXk6IGtleSxcclxuICAgICAgICBDb250ZW50VHlwZTogY29udGVudFR5cGUsXHJcbiAgICAgICAgQUNMOiAncHVibGljLXJlYWQnLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHVwbG9hZFVybCA9IGF3YWl0IGdldFNpZ25lZFVybCh0aGlzLnMzQ2xpZW50LCBjb21tYW5kLCB7IGV4cGlyZXNJbiB9KTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgdXBsb2FkVXJsLFxyXG4gICAgICAgIGtleSxcclxuICAgICAgICBleHBpcmVzSW4sXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1MzIHByZXNpZ25lZCBVUkwgZXJyb3I6JywgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGdlbmVyYXRlIHByZXNpZ25lZCBVUkw6ICR7ZXJyb3IubWVzc2FnZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFByZXNpZ25lZERvd25sb2FkVXJsKFxyXG4gICAga2V5OiBzdHJpbmcsIFxyXG4gICAgZXhwaXJlc0luOiBudW1iZXIgPSAzNjAwXHJcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0T2JqZWN0Q29tbWFuZCh7XHJcbiAgICAgICAgQnVja2V0OiB0aGlzLmNvbmZpZy5idWNrZXROYW1lLFxyXG4gICAgICAgIEtleToga2V5LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHJldHVybiBhd2FpdCBnZXRTaWduZWRVcmwodGhpcy5zM0NsaWVudCwgY29tbWFuZCwgeyBleHBpcmVzSW4gfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1MzIHByZXNpZ25lZCBkb3dubG9hZCBVUkwgZXJyb3I6JywgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGdlbmVyYXRlIHByZXNpZ25lZCBkb3dubG9hZCBVUkw6ICR7ZXJyb3IubWVzc2FnZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGRlbGV0ZUZpbGUoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVsZXRlT2JqZWN0Q29tbWFuZCh7XHJcbiAgICAgICAgQnVja2V0OiB0aGlzLmNvbmZpZy5idWNrZXROYW1lLFxyXG4gICAgICAgIEtleToga2V5LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF3YWl0IHRoaXMuczNDbGllbnQuc2VuZChjb21tYW5kKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUzMgZGVsZXRlIGVycm9yOicsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBkZWxldGUgZmlsZSBmcm9tIFMzOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRGaWxlTWV0YWRhdGEoa2V5OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBIZWFkT2JqZWN0Q29tbWFuZCh7XHJcbiAgICAgICAgQnVja2V0OiB0aGlzLmNvbmZpZy5idWNrZXROYW1lLFxyXG4gICAgICAgIEtleToga2V5LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zM0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG4gICAgICBcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzaXplOiByZXNwb25zZS5Db250ZW50TGVuZ3RoLFxyXG4gICAgICAgIGNvbnRlbnRUeXBlOiByZXNwb25zZS5Db250ZW50VHlwZSxcclxuICAgICAgICBsYXN0TW9kaWZpZWQ6IHJlc3BvbnNlLkxhc3RNb2RpZmllZCxcclxuICAgICAgICBtZXRhZGF0YTogcmVzcG9uc2UuTWV0YWRhdGEsXHJcbiAgICAgICAgZXRhZzogcmVzcG9uc2UuRVRhZyxcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUzMgaGVhZCBvYmplY3QgZXJyb3I6JywgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGdldCBmaWxlIG1ldGFkYXRhOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZW5lcmF0ZUtleShwcmVmaXg6IHN0cmluZywgZmlsZW5hbWU6IHN0cmluZywgdXNlcklkPzogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XHJcbiAgICBjb25zdCByYW5kb20gPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMiwgMTUpO1xyXG4gICAgY29uc3Qgc2FuaXRpemVkRmlsZW5hbWUgPSBmaWxlbmFtZS5yZXBsYWNlKC9bXmEtekEtWjAtOS4tXS9nLCAnXycpO1xyXG4gICAgXHJcbiAgICBpZiAodXNlcklkKSB7XHJcbiAgICAgIHJldHVybiBgJHtwcmVmaXh9LyR7dXNlcklkfS8ke3RpbWVzdGFtcH1fJHtyYW5kb219XyR7c2FuaXRpemVkRmlsZW5hbWV9YDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIGAke3ByZWZpeH0vJHt0aW1lc3RhbXB9XyR7cmFuZG9tfV8ke3Nhbml0aXplZEZpbGVuYW1lfWA7XHJcbiAgfVxyXG5cclxuICBnZXRQdWJsaWNVcmwoa2V5OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKHRoaXMuY29uZmlnLmNsb3VkRnJvbnREb21haW4pIHtcclxuICAgICAgcmV0dXJuIGBodHRwczovLyR7dGhpcy5jb25maWcuY2xvdWRGcm9udERvbWFpbn0vJHtrZXl9YDtcclxuICAgIH1cclxuICAgIHJldHVybiBgaHR0cHM6Ly8ke3RoaXMuY29uZmlnLmJ1Y2tldE5hbWV9LnMzLiR7dGhpcy5jb25maWcucmVnaW9ufS5hbWF6b25hd3MuY29tLyR7a2V5fWA7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBBV1NTM1NlcnZpY2U7XHJcbmV4cG9ydCB0eXBlIHsgXHJcbiAgUzNDb25maWcsIFxyXG4gIFMzVXBsb2FkUmVzcG9uc2UsIFxyXG4gIFMzUHJlc2lnbmVkVXJsUmVzcG9uc2UgXHJcbn07Il19