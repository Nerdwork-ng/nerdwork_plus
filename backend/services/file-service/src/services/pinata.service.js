import axios from 'axios';
import FormData from 'form-data';
class PinataService {
    config;
    constructor(config) {
        this.config = config;
    }
    async uploadFile(fileBuffer, filename, options) {
        try {
            const formData = new FormData();
            formData.append('file', fileBuffer, {
                filename,
                contentType: this.getMimeType(filename),
            });
            if (options?.metadata) {
                formData.append('pinataMetadata', JSON.stringify({
                    name: filename,
                    ...options.metadata
                }));
            }
            if (options?.pinataOptions) {
                formData.append('pinataOptions', JSON.stringify(options.pinataOptions));
            }
            const response = await axios.post(`${this.config.baseUrl}/pinning/pinFileToIPFS`, formData, {
                headers: {
                    'Authorization': `Bearer ${this.config.apiKey}`,
                    ...formData.getHeaders(),
                },
            });
            return {
                ...response.data,
                originalname: filename,
                mimetype: this.getMimeType(filename),
            };
        }
        catch (error) {
            console.error('Pinata upload file error:', error.response?.data || error.message);
            throw new Error(`Failed to upload file to IPFS: ${error.response?.data?.message || error.message}`);
        }
    }
    async uploadJson(jsonObject, options) {
        try {
            const data = {
                pinataContent: jsonObject,
                pinataMetadata: options?.metadata || {},
                pinataOptions: options?.pinataOptions || {}
            };
            const response = await axios.post(`${this.config.baseUrl}/pinning/pinJSONToIPFS`, data, {
                headers: {
                    'Authorization': `Bearer ${this.config.apiKey}`,
                    'Content-Type': 'application/json',
                },
            });
            return {
                ...response.data,
                metadata: jsonObject,
            };
        }
        catch (error) {
            console.error('Pinata upload JSON error:', error.response?.data || error.message);
            throw new Error(`Failed to upload JSON to IPFS: ${error.response?.data?.message || error.message}`);
        }
    }
    async unpinFile(ipfsHash) {
        try {
            await axios.delete(`${this.config.baseUrl}/pinning/unpin/${ipfsHash}`, {
                headers: {
                    'Authorization': `Bearer ${this.config.apiKey}`,
                },
            });
        }
        catch (error) {
            console.error('Pinata unpin error:', error.response?.data || error.message);
            throw new Error(`Failed to unpin file from IPFS: ${error.response?.data?.message || error.message}`);
        }
    }
    async getPinnedFiles(options) {
        try {
            const params = new URLSearchParams();
            if (options?.status)
                params.append('status', options.status);
            if (options?.pageLimit)
                params.append('pageLimit', options.pageLimit.toString());
            if (options?.pageOffset)
                params.append('pageOffset', options.pageOffset.toString());
            if (options?.metadata) {
                Object.entries(options.metadata).forEach(([key, value]) => {
                    params.append(`metadata[${key}]`, value);
                });
            }
            const response = await axios.get(`${this.config.baseUrl}/data/pinList?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${this.config.apiKey}`,
                },
            });
            return response.data;
        }
        catch (error) {
            console.error('Pinata get pinned files error:', error.response?.data || error.message);
            throw new Error(`Failed to get pinned files: ${error.response?.data?.message || error.message}`);
        }
    }
    getGatewayUrl(ipfsHash, isDedicated = false) {
        if (isDedicated && process.env.PINATA_DEDICATED_GATEWAY) {
            return `https://${process.env.PINATA_DEDICATED_GATEWAY}/ipfs/${ipfsHash}`;
        }
        return `https://gateway.pinata.cloud/ipfs/${ipfsHash}`;
    }
    getMimeType(filename) {
        const ext = filename.toLowerCase().split('.').pop();
        const mimeTypes = {
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'png': 'image/png',
            'gif': 'image/gif',
            'webp': 'image/webp',
            'pdf': 'application/pdf',
            'json': 'application/json',
            'txt': 'text/plain',
            'mp4': 'video/mp4',
            'webm': 'video/webm',
            'mp3': 'audio/mpeg',
            'wav': 'audio/wav',
        };
        return mimeTypes[ext || ''] || 'application/octet-stream';
    }
}
export default PinataService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGluYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwaW5hdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxRQUFRLE1BQU0sV0FBVyxDQUFDO0FBdUJqQyxNQUFNLGFBQWE7SUFDVCxNQUFNLENBQWU7SUFFN0IsWUFBWSxNQUFvQjtRQUM5QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FDZCxVQUFrQixFQUNsQixRQUFnQixFQUNoQixPQU1DO1FBRUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNoQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUU7Z0JBQ2xDLFFBQVE7Z0JBQ1IsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDO2FBQ3hDLENBQUMsQ0FBQztZQUVILElBQUksT0FBTyxFQUFFLFFBQVEsRUFBRSxDQUFDO2dCQUN0QixRQUFRLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7b0JBQy9DLElBQUksRUFBRSxRQUFRO29CQUNkLEdBQUcsT0FBTyxDQUFDLFFBQVE7aUJBQ3BCLENBQUMsQ0FBQyxDQUFDO1lBQ04sQ0FBQztZQUVELElBQUksT0FBTyxFQUFFLGFBQWEsRUFBRSxDQUFDO2dCQUMzQixRQUFRLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQzFFLENBQUM7WUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQy9CLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLHdCQUF3QixFQUM5QyxRQUFRLEVB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QyxRQUFRLEVBQUUsSUFBSSxFQUFFLE9BQU8sSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUNuRyxDQUFDO0lBQ0gsQ0FBQztJQUVELGFBQWEsQ0FBQyxRQUFnQixFQUFFLGNBQXVCLEtBQUs7UUFDMUQsSUFBSSxXQUFXLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1lBQ3hELE9BQU8sV0FBVyxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixTQUFTLFFBQVEsRUFBRSxDQUFDO1FBQzVFLENBQUM7UUFDRCxPQUFPLHFDQUFxQyxRQUFRLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0lBRU8sV0FBVyxDQUFDLFFBQWdCO1FBQ2xDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDcEQsTUFBTSxTQUFTLEdBQThCO1lBQzNDLEtBQUssRUFBRSxZQUFZO1lBQ25CLE1BQU0sRUFBRSxZQUFZO1lBQ3BCLEtBQUssRUFBRSxXQUFXO1lBQ2xCLEtBQUssRUFBRSxXQUFXO1lBQ2xCLE1BQU0sRUFBRSxZQUFZO1lBQ3BCLEtBQUssRUFBRSxpQkFBaUI7WUFDeEIsTUFBTSxFQUFFLGtCQUFrQjtZQUMxQixLQUFLLEVBQUUsWUFBWTtZQUNuQixLQUFLLEVBQUUsV0FBVztZQUNsQixNQUFNLEVBQUUsWUFBWTtZQUNwQixLQUFLLEVBQUUsWUFBWTtZQUNuQixLQUFLLEVBQUUsV0FBVztTQUNuQixDQUFDO1FBQ0YsT0FBTyxTQUFTLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxJQUFJLDBCQUEwQixDQUFDO0lBQzVELENBQUM7Q0FDRjtBQUVELGVBQWUsYUFBYSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcclxuaW1wb3J0IEZvcm1EYXRhIGZyb20gJ2Zvcm0tZGF0YSc7XHJcblxyXG5pbnRlcmZhY2UgUGluYXRhQ29uZmlnIHtcclxuICBhcGlLZXk6IHN0cmluZztcclxuICBhcGlTZWNyZXQ6IHN0cmluZztcclxuICBiYXNlVXJsOiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBQaW5hdGFVcGxvYWRSZXNwb25zZSB7XHJcbiAgSXBmc0hhc2g6IHN0cmluZztcclxuICBQaW5TaXplOiBudW1iZXI7XHJcbiAgVGltZXN0YW1wOiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBQaW5hdGFGaWxlUmVzcG9uc2UgZXh0ZW5kcyBQaW5hdGFVcGxvYWRSZXNwb25zZSB7XHJcbiAgb3JpZ2luYWxuYW1lOiBzdHJpbmc7XHJcbiAgbWltZXR5cGU6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIFBpbmF0YUpzb25SZXNwb25zZSBleHRlbmRzIFBpbmF0YVVwbG9hZFJlc3BvbnNlIHtcclxuICBtZXRhZGF0YTogYW55O1xyXG59XHJcblxyXG5jbGFzcyBQaW5hdGFTZXJ2aWNlIHtcclxuICBwcml2YXRlIGNvbmZpZzogUGluYXRhQ29uZmlnO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFBpbmF0YUNvbmZpZykge1xyXG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGxvYWRGaWxlKFxyXG4gICAgZmlsZUJ1ZmZlcjogQnVmZmVyLCBcclxuICAgIGZpbGVuYW1lOiBzdHJpbmcsIFxyXG4gICAgb3B0aW9ucz86IHtcclxuICAgICAgbWV0YWRhdGE/OiBhbnk7XHJcbiAgICAgIHBpbmF0YU9wdGlvbnM/OiB7XHJcbiAgICAgICAgY2lkVmVyc2lvbj86IDAgfCAxO1xyXG4gICAgICAgIHdyYXBXaXRoRGlyZWN0b3J5PzogYm9vbGVhbjtcclxuICAgICAgfTtcclxuICAgIH1cclxuICApOiBQcm9taXNlPFBpbmF0YUZpbGVSZXNwb25zZT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcclxuICAgICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgZmlsZUJ1ZmZlciwge1xyXG4gICAgICAgIGZpbGVuYW1lLFxyXG4gICAgICAgIGNvbnRlbnRUeXBlOiB0aGlzLmdldE1pbWVUeXBlKGZpbGVuYW1lKSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAob3B0aW9ucz8ubWV0YWRhdGEpIHtcclxuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3BpbmF0YU1ldGFkYXRhJywgSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgbmFtZTogZmlsZW5hbWUsXHJcbiAgICAgICAgICAuLi5vcHRpb25zLm1ldGFkYXRhXHJcbiAgICAgICAgfSkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAob3B0aW9ucz8ucGluYXRhT3B0aW9ucykge1xyXG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncGluYXRhT3B0aW9ucycsIEpTT04uc3RyaW5naWZ5KG9wdGlvbnMucGluYXRhT3B0aW9ucykpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLnBvc3QoXHJcbiAgICAgICAgYCR7dGhpcy5jb25maWcuYmFzZVVybH0vcGlubmluZy9waW5GaWxlVG9JUEZTYCxcclxuICAgICAgICBmb3JtRGF0YSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3RoaXMuY29uZmlnLmFwaUtleX1gLFxyXG4gICAgICAgICAgICAuLi5mb3JtRGF0YS5nZXRIZWFkZXJzKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4ucmVzcG9uc2UuZGF0YSxcclxuICAgICAgICBvcmlnaW5hbG5hbWU6IGZpbGVuYW1lLFxyXG4gICAgICAgIG1pbWV0eXBlOiB0aGlzLmdldE1pbWVUeXBlKGZpbGVuYW1lKSxcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUGluYXRhIHVwbG9hZCBmaWxlIGVycm9yOicsIGVycm9yLnJlc3BvbnNlPy5kYXRhIHx8IGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byB1cGxvYWQgZmlsZSB0byBJUEZTOiAke2Vycm9yLnJlc3BvbnNlPy5kYXRhPy5tZXNzYWdlIHx8IGVycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGxvYWRKc29uKFxyXG4gICAganNvbk9iamVjdDogYW55LCBcclxuICAgIG9wdGlvbnM/OiB7XHJcbiAgICAgIG1ldGFkYXRhPzogYW55O1xyXG4gICAgICBwaW5hdGFPcHRpb25zPzoge1xyXG4gICAgICAgIGNpZFZlcnNpb24/OiAwIHwgMTtcclxuICAgICAgICB3cmFwV2l0aERpcmVjdG9yeT86IGJvb2xlYW47XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgKTogUHJvbWlzZTxQaW5hdGFKc29uUmVzcG9uc2U+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgcGluYXRhQ29udGVudDoganNvbk9iamVjdCxcclxuICAgICAgICBwaW5hdGFNZXRhZGF0YTogb3B0aW9ucz8ubWV0YWRhdGEgfHwge30sXHJcbiAgICAgICAgcGluYXRhT3B0aW9uczogb3B0aW9ucz8ucGluYXRhT3B0aW9ucyB8fCB7fVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KFxyXG4gICAgICAgIGAke3RoaXMuY29uZmlnLmJhc2VVcmx9L3Bpbm5pbmcvcGluSlNPTlRvSVBGU2AsXHJcbiAgICAgICAgZGF0YSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3RoaXMuY29uZmlnLmFwaUtleX1gLFxyXG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnJlc3BvbnNlLmRhdGEsXHJcbiAgICAgICAgbWV0YWRhdGE6IGpzb25PYmplY3QsXHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1BpbmF0YSB1cGxvYWQgSlNPTiBlcnJvcjonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gdXBsb2FkIEpTT04gdG8gSVBGUzogJHtlcnJvci5yZXNwb25zZT8uZGF0YT8ubWVzc2FnZSB8fCBlcnJvci5tZXNzYWdlfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgdW5waW5GaWxlKGlwZnNIYXNoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IGF4aW9zLmRlbGV0ZShcclxuICAgICAgICBgJHt0aGlzLmNvbmZpZy5iYXNlVXJsfS9waW5uaW5nL3VucGluLyR7aXBmc0hhc2h9YCxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3RoaXMuY29uZmlnLmFwaUtleX1gLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1BpbmF0YSB1bnBpbiBlcnJvcjonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gdW5waW4gZmlsZSBmcm9tIElQRlM6ICR7ZXJyb3IucmVzcG9uc2U/LmRhdGE/Lm1lc3NhZ2UgfHwgZXJyb3IubWVzc2FnZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFBpbm5lZEZpbGVzKFxyXG4gICAgb3B0aW9ucz86IHtcclxuICAgICAgc3RhdHVzPzogJ3Bpbm5lZCcgfCAndW5waW5uZWQnO1xyXG4gICAgICBwYWdlTGltaXQ/OiBudW1iZXI7XHJcbiAgICAgIHBhZ2VPZmZzZXQ/OiBudW1iZXI7XHJcbiAgICAgIG1ldGFkYXRhPzogYW55O1xyXG4gICAgfVxyXG4gICk6IFByb21pc2U8YW55PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7XHJcbiAgICAgIFxyXG4gICAgICBpZiAob3B0aW9ucz8uc3RhdHVzKSBwYXJhbXMuYXBwZW5kKCdzdGF0dXMnLCBvcHRpb25zLnN0YXR1cyk7XHJcbiAgICAgIGlmIChvcHRpb25zPy5wYWdlTGltaXQpIHBhcmFtcy5hcHBlbmQoJ3BhZ2VMaW1pdCcsIG9wdGlvbnMucGFnZUxpbWl0LnRvU3RyaW5nKCkpO1xyXG4gICAgICBpZiAob3B0aW9ucz8ucGFnZU9mZnNldCkgcGFyYW1zLmFwcGVuZCgncGFnZU9mZnNldCcsIG9wdGlvbnMucGFnZU9mZnNldC50b1N0cmluZygpKTtcclxuICAgICAgaWYgKG9wdGlvbnM/Lm1ldGFkYXRhKSB7XHJcbiAgICAgICAgT2JqZWN0LmVudHJpZXMob3B0aW9ucy5tZXRhZGF0YSkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgICAgICBwYXJhbXMuYXBwZW5kKGBtZXRhZGF0YVske2tleX1dYCwgdmFsdWUgYXMgc3RyaW5nKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5nZXQoXHJcbiAgICAgICAgYCR7dGhpcy5jb25maWcuYmFzZVVybH0vZGF0YS9waW5MaXN0PyR7cGFyYW1zLnRvU3RyaW5nKCl9YCxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3RoaXMuY29uZmlnLmFwaUtleX1gLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcclxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUGluYXRhIGdldCBwaW5uZWQgZmlsZXMgZXJyb3I6JywgZXJyb3IucmVzcG9uc2U/LmRhdGEgfHwgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGdldCBwaW5uZWQgZmlsZXM6ICR7ZXJyb3IucmVzcG9uc2U/LmRhdGE/Lm1lc3NhZ2UgfHwgZXJyb3IubWVzc2FnZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldEdhdGV3YXlVcmwoaXBmc0hhc2g6IHN0cmluZywgaXNEZWRpY2F0ZWQ6IGJvb2xlYW4gPSBmYWxzZSk6IHN0cmluZyB7XHJcbiAgICBpZiAoaXNEZWRpY2F0ZWQgJiYgcHJvY2Vzcy5lbnYuUElOQVRBX0RFRElDQVRFRF9HQVRFV0FZKSB7XHJcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke3Byb2Nlc3MuZW52LlBJTkFUQV9ERURJQ0FURURfR0FURVdBWX0vaXBmcy8ke2lwZnNIYXNofWA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYGh0dHBzOi8vZ2F0ZXdheS5waW5hdGEuY2xvdWQvaXBmcy8ke2lwZnNIYXNofWA7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldE1pbWVUeXBlKGZpbGVuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgZXh0ID0gZmlsZW5hbWUudG9Mb3dlckNhc2UoKS5zcGxpdCgnLicpLnBvcCgpO1xyXG4gICAgY29uc3QgbWltZVR5cGVzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge1xyXG4gICAgICAnanBnJzogJ2ltYWdlL2pwZWcnLFxyXG4gICAgICAnanBlZyc6ICdpbWFnZS9qcGVnJyxcclxuICAgICAgJ3BuZyc6ICdpbWFnZS9wbmcnLFxyXG4gICAgICAnZ2lmJzogJ2ltYWdlL2dpZicsXHJcbiAgICAgICd3ZWJwJzogJ2ltYWdlL3dlYnAnLFxyXG4gICAgICAncGRmJzogJ2FwcGxpY2F0aW9uL3BkZicsXHJcbiAgICAgICdqc29uJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAndHh0JzogJ3RleHQvcGxhaW4nLFxyXG4gICAgICAnbXA0JzogJ3ZpZGVvL21wNCcsXHJcbiAgICAgICd3ZWJtJzogJ3ZpZGVvL3dlYm0nLFxyXG4gICAgICAnbXAzJzogJ2F1ZGlvL21wZWcnLFxyXG4gICAgICAnd2F2JzogJ2F1ZGlvL3dhdicsXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIG1pbWVUeXBlc1tleHQgfHwgJyddIHx8ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgUGluYXRhU2VydmljZTtcclxuZXhwb3J0IHR5cGUgeyBcclxuICBQaW5hdGFDb25maWcsIFxyXG4gIFBpbmF0YVVwbG9hZFJlc3BvbnNlLCBcclxuICBQaW5hdGFGaWxlUmVzcG9uc2UsIFxyXG4gIFBpbmF0YUpzb25SZXNwb25zZSBcclxufTsiXX0=