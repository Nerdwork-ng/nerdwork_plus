import { eq } from "drizzle-orm";
import { db } from "../config/db";
import { payments } from "../model/schema";
import { sdk } from "../config/helio.config";
const HELIO_API_BASE = "https://api.dev.hel.io/v1";
// const HELIO_API_BASE = "https://api.hel.io/v1"; // For production
const HELIO_PUBLIC_KEY = process.env.HELIO_PUBLIC_KEY;
const HELIO_PRIVATE_KEY = process.env.HELIO_PRIVATE_KEY;
const WEBHOOK_REDIRECT_URL = process.env.WEBHOOK_REDIRECT_URL;
export const createPaymentLink = async (req, res) => {
    if (!req.user) {
        return res.status(401).json({ message: "Unauthorized: User not authenticated" });
    }
    try {
        const { amount, name } = req.body;
        if (!amount) {
            return res.status(400).json({
                error: 'Missing required fields: amount, currency, name'
            });
        }
        // const currencies = await sdk.currency.getAllCurrencies();
        // return res.status(200).json({
        //     success: true,  
        //     currencies
        // });
        // Prepare DTO for Helio
        const createPaylinkDto = {
            name: req.user.id + name + new Date().toISOString(), // Unique name for each payment link
            price: (Number(amount) * 1000000).toString(), // Ensure amount is a number
            pricingCurrency: "63777da9d2f1ab96ae0ee600",
            description: `Payment for Nerd Work Token by ${req.user.id} on ${new Date().toISOString()} amount: ${amount} `,
            features: {},
            recipients: [
                {
                    walletId: "685ef2364608b2fabd47f02d",
                    currencyId: "66e2b724a88df2dcc5f63fe8"
                }
            ],
        };
        // Call Helio SDK
        const helioResponse = await sdk.paylink.create(createPaylinkDto);
        console.log(req.user);
        // get user from db
        const user = await db.query.authUsers.findFirst({
            where: (users, { eq }) => eq(users.id, req.user.id),
            with: {
                profile: true, // ðŸ‘ˆ include the wallet relation here
            },
        });
        console.log(user);
        const userProfile = await db.query.userProfiles.findFirst({
            where: (profiles, { eq }) => eq(profiles.id, user.profile.id),
            with: {
                wallet: true
            }
        });
        if (!user) {
            return res.status(404).json({ error: 'User not found' });
        }
        // Insert into DB
        const paymentToInsert = {
            userWalletId: userProfile.wallet.id || "testuser", // adjust as needed
            amount: helioResponse.price.toString(),
            currency: helioResponse.currency?.symbol || "USD", // Default to USD if not provided
            nwtAmount: amount,
            exchangeRate: "100",
            paymentIntentId: helioResponse.id,
            blockchainTxHash: null,
            status: "pending",
            failureReason: null,
            metadata: helioResponse, // Save full response for reference
            processedAt: null,
            // createdAt and updatedAt will default to now
        };
        await db.insert(payments).values(paymentToInsert);
        console.log(helioResponse.id);
        // Return the full Helio response
        res.json({
            success: true,
            payment: helioResponse,
            paylinkId: helioResponse.id
        });
    }
    catch (error) {
        console.error('Helio payment link creation error:', error.response?.data || error.message);
        res.status(500).json({
            error: 'Failed to create payment link',
            details: error.response?.data || error.message
        });
    }
};
export const createWebhookForPayment = async (req, res) => {
    if (!req.user) {
        return res.status(401).json({ message: "Unauthorized: User not authenticated" });
    }
    try {
        const { paymentId } = req.body;
        const events = ["CREATED"];
        const webhookPayload = {
            name: "Nerd Work Payment Webhook",
            targetUrl: WEBHOOK_REDIRECT_URL || "http://localhost:5000/helio/webhook/handle",
            paylinkId: paymentId,
        };
        const response = await sdk.paylinkWebhook.createPaylinkWebhook(webhookPayload);
        console.log('Webhook created successfully:', response);
        await db.update(payments)
            .set({ webhookId: response.id }) // Add this column if you want to store webhookId
            .where(eq(payments.paymentIntentId, paymentId));
        res.json({
            success: true,
            data: response
        });
    }
    catch (error) {
        console.error('Helio payment webhhok :', error.response?.data || error.message);
        res.status(500).json({
            error: 'Failed to create webhook',
            details: error.response?.data || error.message
        });
    }
};
export const handlePaymentWebhook = async (req, res) => {
    try {
        console.log(req.body);
        const { event, data } = req.body;
        console.log('Received webhook event:', event, 'with data:', data);
        // Example: Update payment status and metadata based on webhook event
        if (data?.id) {
            await db.update(payments)
                .set({
                status: data.status || 'processing',
                failureReason: data.failureReason || null,
                blockchainTxHash: data.blockchainTxHash || null,
                processedAt: data.processedAt ? new Date(data.processedAt) : null,
                metadata: data, // Save the full webhook data for reference
                updatedAt: new Date()
            })
                .where(eq(payments.paymentIntentId, data.id));
        }
        res.status(200).json({ success: true });
    }
    catch (error) {
        console.error('Error handling payment webhook:', error.message);
        res.status(500).json({ error: 'Internal Server Error' });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC5jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGF5bWVudC5jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNsQyxPQUFPLEVBQUUsUUFBUSxFQUFnQixNQUFNLGlCQUFpQixDQUFDO0FBRXpELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU3QyxNQUFNLGNBQWMsR0FBRywyQkFBMkIsQ0FBQztBQUNuRCxvRUFBb0U7QUFDcEUsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO0FBQ3RELE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQztBQUN4RCxNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUM7QUFJOUQsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUcsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtJQUMxRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxzQ0FBc0MsRUFBRSxDQUFDLENBQUM7SUFDckYsQ0FBQztJQUNELElBQUksQ0FBQztRQUNELE1BQU0sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUVsQyxJQUFJLENBQUMsTUFBTSxFQUFHLENBQUM7WUFDWCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUN4QixLQUFLLEVBQUUsaURBQWlEO2FBQzNE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QUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcSB9IGZyb20gXCJkcml6emxlLW9ybVwiO1xyXG5pbXBvcnQgeyBkYiB9IGZyb20gXCIuLi9jb25maWcvZGJcIjtcclxuaW1wb3J0IHsgcGF5bWVudHMsIHVzZXJQcm9maWxlcyB9IGZyb20gXCIuLi9tb2RlbC9zY2hlbWFcIjtcclxuaW1wb3J0IGF4aW9zIGZyb20gXCJheGlvc1wiO1xyXG5pbXBvcnQgeyBzZGsgfSBmcm9tIFwiLi4vY29uZmlnL2hlbGlvLmNvbmZpZ1wiO1xyXG5pbXBvcnQgeyBDcmVhdGVQYXlsaW5rSG9va0J5QXBpS2V5RHRvLCBDcmVhdGVQYXlsaW5rV2l0aEFwaUR0byB9IGZyb20gXCJAaGVsaW9maS9jb21tb25cIjtcclxuY29uc3QgSEVMSU9fQVBJX0JBU0UgPSBcImh0dHBzOi8vYXBpLmRldi5oZWwuaW8vdjFcIjtcclxuLy8gY29uc3QgSEVMSU9fQVBJX0JBU0UgPSBcImh0dHBzOi8vYXBpLmhlbC5pby92MVwiOyAvLyBGb3IgcHJvZHVjdGlvblxyXG5jb25zdCBIRUxJT19QVUJMSUNfS0VZID0gcHJvY2Vzcy5lbnYuSEVMSU9fUFVCTElDX0tFWTtcclxuY29uc3QgSEVMSU9fUFJJVkFURV9LRVkgPSBwcm9jZXNzLmVudi5IRUxJT19QUklWQVRFX0tFWTtcclxuY29uc3QgV0VCSE9PS19SRURJUkVDVF9VUkwgPSBwcm9jZXNzLmVudi5XRUJIT09LX1JFRElSRUNUX1VSTDtcclxuXHJcbmltcG9ydCB7IEluc2VydFBheW1lbnQgfSBmcm9tIFwiLi4vbW9kZWwvcGF5bWVudFwiOyAvLyBNYWtlIHN1cmUgdGhpcyBpbXBvcnQgZXhpc3RzXHJcblxyXG5leHBvcnQgY29uc3QgY3JlYXRlUGF5bWVudExpbmsgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWQ6IFVzZXIgbm90IGF1dGhlbnRpY2F0ZWRcIiB9KTtcclxuICAgIH1cclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgeyBhbW91bnQsIG5hbWUgfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgICAgICBpZiAoIWFtb3VudCApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICAgICAgICAgIGVycm9yOiAnTWlzc2luZyByZXF1aXJlZCBmaWVsZHM6IGFtb3VudCwgY3VycmVuY3ksIG5hbWUnXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjb25zdCBjdXJyZW5jaWVzID0gYXdhaXQgc2RrLmN1cnJlbmN5LmdldEFsbEN1cnJlbmNpZXMoKTtcclxuICAgICAgICAvLyByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgIC8vICAgICBzdWNjZXNzOiB0cnVlLCAgXHJcbiAgICAgICAgLy8gICAgIGN1cnJlbmNpZXNcclxuICAgICAgICAvLyB9KTtcclxuXHJcbiAgICAgICAgLy8gUHJlcGFyZSBEVE8gZm9yIEhlbGlvXHJcbiAgICAgICAgY29uc3QgY3JlYXRlUGF5bGlua0R0bzogQ3JlYXRlUGF5bGlua1dpdGhBcGlEdG8gPSB7XHJcbiAgICAgICAgICAgIG5hbWU6IHJlcS51c2VyLmlkICsgbmFtZSArIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgLy8gVW5pcXVlIG5hbWUgZm9yIGVhY2ggcGF5bWVudCBsaW5rXHJcbiAgICAgICAgICAgIHByaWNlOiAoTnVtYmVyKGFtb3VudCkgKiAxMDAwMDAwKS50b1N0cmluZygpLCAvLyBFbnN1cmUgYW1vdW50IGlzIGEgbnVtYmVyXHJcbiAgICAgICAgICAgIHByaWNpbmdDdXJyZW5jeTogXCI2Mzc3N2RhOWQyZjFhYjk2YWUwZWU2MDBcIixcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBQYXltZW50IGZvciBOZXJkIFdvcmsgVG9rZW4gYnkgJHtyZXEudXNlci5pZH0gb24gJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCl9IGFtb3VudDogJHthbW91bnR9IGAsXHJcbiAgICAgICAgICAgIGZlYXR1cmVzOiB7fSxcclxuICAgICAgICAgICAgcmVjaXBpZW50czogW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHdhbGxldElkOiBcIjY4NWVmMjM2NDYwOGIyZmFiZDQ3ZjAyZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbmN5SWQ6IFwiNjZlMmI3MjRhODhkZjJkY2M1ZjYzZmU4XCJcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyBDYWxsIEhlbGlvIFNES1xyXG4gICAgICAgIGNvbnN0IGhlbGlvUmVzcG9uc2UgPSBhd2FpdCBzZGsucGF5bGluay5jcmVhdGUoY3JlYXRlUGF5bGlua0R0byk7XHJcblxyXG4gICAgICAgY29uc29sZS5sb2cocmVxLnVzZXIpXHJcbiAgICAgICAgLy8gZ2V0IHVzZXIgZnJvbSBkYlxyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBkYi5xdWVyeS5hdXRoVXNlcnMuZmluZEZpcnN0KHtcclxuICAgICAgICAgICAgd2hlcmU6ICh1c2VycywgeyBlcSB9KSA9PiBlcSh1c2Vycy5pZCwgcmVxLnVzZXIuaWQpLFxyXG4gICAgICAgICAgICB3aXRoOiB7XHJcbiAgICAgICAgICAgICAgICBwcm9maWxlOiB0cnVlLCAvLyDwn5GIIGluY2x1ZGUgdGhlIHdhbGxldCByZWxhdGlvbiBoZXJlXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICBcclxuICAgICAgICBjb25zb2xlLmxvZyh1c2VyKVxyXG5cclxuICAgICAgICBjb25zdCB1c2VyUHJvZmlsZSA9IGF3YWl0IGRiLnF1ZXJ5LnVzZXJQcm9maWxlcy5maW5kRmlyc3Qoe1xyXG4gICAgICAgICAgICB3aGVyZToocHJvZmlsZXMsIHtlcX0pID0+IGVxKHByb2ZpbGVzLmlkLCB1c2VyLnByb2ZpbGUuaWQpLFxyXG4gICAgICAgICAgICB3aXRoOiB7XHJcbiAgICAgICAgICAgICAgICB3YWxsZXQ6IHRydWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIFxyXG5cclxuICAgICAgICBpZiAoIXVzZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBJbnNlcnQgaW50byBEQlxyXG4gICAgICAgIGNvbnN0IHBheW1lbnRUb0luc2VydDogSW5zZXJ0UGF5bWVudCA9IHtcclxuICAgICAgICAgICAgdXNlcldhbGxldElkOiB1c2VyUHJvZmlsZS53YWxsZXQuaWQgfHwgXCJ0ZXN0dXNlclwiLCAvLyBhZGp1c3QgYXMgbmVlZGVkXHJcbiAgICAgICAgICAgIGFtb3VudDogaGVsaW9SZXNwb25zZS5wcmljZS50b1N0cmluZygpLFxyXG4gICAgICAgICAgICBjdXJyZW5jeTogaGVsaW9SZXNwb25zZS5jdXJyZW5jeT8uc3ltYm9sIHx8IFwiVVNEXCIsIC8vIERlZmF1bHQgdG8gVVNEIGlmIG5vdCBwcm92aWRlZFxyXG4gICAgICAgICAgICBud3RBbW91bnQ6IGFtb3VudCxcclxuICAgICAgICAgICAgZXhjaGFuZ2VSYXRlOiBcIjEwMFwiLFxyXG4gICAgICAgICAgICBwYXltZW50SW50ZW50SWQ6IGhlbGlvUmVzcG9uc2UuaWQsXHJcbiAgICAgICAgICAgIGJsb2NrY2hhaW5UeEhhc2g6IG51bGwsXHJcbiAgICAgICAgICAgIHN0YXR1czogXCJwZW5kaW5nXCIsXHJcbiAgICAgICAgICAgIGZhaWx1cmVSZWFzb246IG51bGwsXHJcbiAgICAgICAgICAgIG1ldGFkYXRhOiBoZWxpb1Jlc3BvbnNlLCAvLyBTYXZlIGZ1bGwgcmVzcG9uc2UgZm9yIHJlZmVyZW5jZVxyXG4gICAgICAgICAgICBwcm9jZXNzZWRBdDogbnVsbCxcclxuICAgICAgICAgICAgLy8gY3JlYXRlZEF0IGFuZCB1cGRhdGVkQXQgd2lsbCBkZWZhdWx0IHRvIG5vd1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGF3YWl0IGRiLmluc2VydChwYXltZW50cykudmFsdWVzKHBheW1lbnRUb0luc2VydCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coaGVsaW9SZXNwb25zZS5pZClcclxuICAgICAgICAvLyBSZXR1cm4gdGhlIGZ1bGwgSGVsaW8gcmVzcG9uc2VcclxuICAgICAgICByZXMuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgIHBheW1lbnQ6IGhlbGlvUmVzcG9uc2UsXHJcbiAgICAgICAgICAgIHBheWxpbmtJZDogaGVsaW9SZXNwb25zZS5pZFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0hlbGlvIHBheW1lbnQgbGluayBjcmVhdGlvbiBlcnJvcjonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGNyZWF0ZSBwYXltZW50IGxpbmsnLFxyXG4gICAgICAgICAgICBkZXRhaWxzOiBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IGNyZWF0ZVdlYmhvb2tGb3JQYXltZW50ID0gYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xyXG4gICAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkOiBVc2VyIG5vdCBhdXRoZW50aWNhdGVkXCIgfSk7XHJcbiAgICB9XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHsgcGF5bWVudElkIH0gPSByZXEuYm9keTtcclxuICAgICAgICBjb25zdCBldmVudHMgPSBbXCJDUkVBVEVEXCJdO1xyXG5cclxuICAgICAgICBjb25zdCB3ZWJob29rUGF5bG9hZCA6Q3JlYXRlUGF5bGlua0hvb2tCeUFwaUtleUR0bz17XHJcbiAgICAgICAgICAgIG5hbWU6IFwiTmVyZCBXb3JrIFBheW1lbnQgV2ViaG9va1wiLFxyXG4gICAgICAgICAgICB0YXJnZXRVcmw6IFdFQkhPT0tfUkVESVJFQ1RfVVJMIHx8IFwiaHR0cDovL2xvY2FsaG9zdDo1MDAwL2hlbGlvL3dlYmhvb2svaGFuZGxlXCIsXHJcbiAgICAgICAgICAgIHBheWxpbmtJZDogcGF5bWVudElkLFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzZGsucGF5bGlua1dlYmhvb2suY3JlYXRlUGF5bGlua1dlYmhvb2sod2ViaG9va1BheWxvYWQpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdXZWJob29rIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5OicsIHJlc3BvbnNlKTtcclxuICAgICAgICBhd2FpdCBkYi51cGRhdGUocGF5bWVudHMpXHJcbiAgICAgICAgICAgIC5zZXQoeyB3ZWJob29rSWQ6IHJlc3BvbnNlLmlkIH0pIC8vIEFkZCB0aGlzIGNvbHVtbiBpZiB5b3Ugd2FudCB0byBzdG9yZSB3ZWJob29rSWRcclxuICAgICAgICAgICAgLndoZXJlKGVxKHBheW1lbnRzLnBheW1lbnRJbnRlbnRJZCwgcGF5bWVudElkKSk7XHJcblxyXG4gICAgICAgIHJlcy5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgZGF0YTogcmVzcG9uc2VcclxuICAgICAgICB9KVxyXG5cclxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgY29uc29sZS5lcnJvcignSGVsaW8gcGF5bWVudCB3ZWJoaG9rIDonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGNyZWF0ZSB3ZWJob29rJyxcclxuICAgICAgICAgICAgZGV0YWlsczogZXJyb3IucmVzcG9uc2U/LmRhdGEgfHwgZXJyb3IubWVzc2FnZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlUGF5bWVudFdlYmhvb2sgPSBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHJlcS5ib2R5KTtcclxuICAgICAgICBjb25zdCB7IGV2ZW50LCBkYXRhIH0gPSByZXEuYm9keTtcclxuICAgICAgICBjb25zb2xlLmxvZygnUmVjZWl2ZWQgd2ViaG9vayBldmVudDonLCBldmVudCwgJ3dpdGggZGF0YTonLCBkYXRhKTtcclxuXHJcbiAgICAgICAgLy8gRXhhbXBsZTogVXBkYXRlIHBheW1lbnQgc3RhdHVzIGFuZCBtZXRhZGF0YSBiYXNlZCBvbiB3ZWJob29rIGV2ZW50XHJcbiAgICAgICAgaWYgKGRhdGE/LmlkKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGRiLnVwZGF0ZShwYXltZW50cylcclxuICAgICAgICAgICAgICAgIC5zZXQoe1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogZGF0YS5zdGF0dXMgfHwgJ3Byb2Nlc3NpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgIGZhaWx1cmVSZWFzb246IGRhdGEuZmFpbHVyZVJlYXNvbiB8fCBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIGJsb2NrY2hhaW5UeEhhc2g6IGRhdGEuYmxvY2tjaGFpblR4SGFzaCB8fCBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZEF0OiBkYXRhLnByb2Nlc3NlZEF0ID8gbmV3IERhdGUoZGF0YS5wcm9jZXNzZWRBdCkgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhOiBkYXRhLCAvLyBTYXZlIHRoZSBmdWxsIHdlYmhvb2sgZGF0YSBmb3IgcmVmZXJlbmNlXHJcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLndoZXJlKGVxKHBheW1lbnRzLnBheW1lbnRJbnRlbnRJZCwgZGF0YS5pZCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBzdWNjZXNzOiB0cnVlIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGhhbmRsaW5nIHBheW1lbnQgd2ViaG9vazonLCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnSW50ZXJuYWwgU2VydmVyIEVycm9yJyB9KTtcclxuICAgIH1cclxufSJdfQ==