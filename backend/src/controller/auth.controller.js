import jwt from "jsonwebtoken";
import { db } from "../config/db";
import { authUsers, creatorProfile, readerProfile } from "../model/schema";
import { OAuth2Client } from "google-auth-library";
import { eq } from "drizzle-orm";
const client = new OAuth2Client(process.env.GOOGLE_CLIENT_ID);
export const googleAuthController = async (req, res) => {
    try {
        const { idToken } = req.body;
        if (!idToken) {
            return res.status(400).json({ error: "Google ID token required" });
        }
        if (!process.env.GOOGLE_CLIENT_ID) {
            return res.status(401).json({ message: "Client id is not defined" });
        }
        // ‚úÖ Verify token with Google
        const ticket = await client.verifyIdToken({
            idToken,
            audience: process.env.GOOGLE_CLIENT_ID,
        });
        const payload = ticket.getPayload();
        if (!payload)
            throw new Error("Invalid Google token");
        const { email, sub: googleId, picture } = payload;
        // ‚úÖ Check if user already exists
        const users = await db
            .select()
            .from(authUsers)
            .where(eq(authUsers.email, email));
        let user = users[0] ?? null;
        if (!user) {
            // ‚úÖ Create new user if not found
            const [newUser] = await db
                .insert(authUsers)
                .values({
                email,
                username: email.split("@")[0],
                emailVerified: true,
                isActive: true,
                passwordHash: "",
            })
                .returning();
            user = newUser;
        }
        // üîç Check if profile exists (creator OR reader)
        const [creator] = await db
            .select()
            .from(creatorProfile)
            .where(eq(creatorProfile.userId, user.id));
        const [reader] = await db
            .select()
            .from(readerProfile)
            .where(eq(readerProfile.userId, user.id));
        const cProfile = !!creator;
        console.log("cProfile", cProfile);
        const rProfile = !!reader;
        console.log("rProfile", rProfile);
        // ‚úÖ Generate JWT
        const token = jwt.sign({ userId: user.id, email: user.email }, process.env.JWT_SECRET, {
            expiresIn: "7d",
        });
        return res.status(200).json({
            token,
            user,
            cProfile,
            rProfile,
        });
    }
    catch (err) {
        console.error(err);
        return res
            .status(500)
            .json({ message: err.message || "Internal Server Error" });
    }
};
export async function verifyGoogleToken(idToken) {
    try {
        const ticket = await client.verifyIdToken({
            idToken,
            audience: process.env.GOOGLE_CLIENT_ID,
        });
        const payload = ticket.getPayload();
        if (!payload)
            throw new Error("Invalid Google token");
        return {
            email: payload.email,
            fullName: payload.name || "",
            picture: payload.picture || "",
            googleId: payload.sub,
        };
    }
    catch (error) {
        throw new Error("Failed to verify Google token");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXV0aC5jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUMvQixPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRWpDLE1BQU0sTUFBTSxHQUFHLElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUU5RCxNQUFNLENBQUMsTUFBTSxvQkFBb0IsR0FBRyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ3JELElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNiLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ2xDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZFLENBQUM7UUFFRCw2QkFBNkI7UUFDN0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxNQUFNLENBQUMsYUFBYSxDQUFDO1lBQ3hDLE9BQU87WUFD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QUM7QUFFRixNQUFNLENBQUMsS0FBSyxVQUFVLGlCQUFpQixDQUFDLE9BQWU7SUFDckQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsTUFBTSxNQUFNLENBQUMsYUFBYSxDQUFDO1lBQ3hDLE9BQU87WUFDUCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0I7U0FDdkMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxPQUFPO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBRXRELE9BQU87WUFDTCxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQU07WUFDckIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksRUFBRTtZQUM1QixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFO1lBQzlCLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRztTQUN0QixDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7SUFDbkQsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgand0IGZyb20gXCJqc29ud2VidG9rZW5cIjtcclxuaW1wb3J0IHsgZGIgfSBmcm9tIFwiLi4vY29uZmlnL2RiXCI7XHJcbmltcG9ydCB7IGF1dGhVc2VycywgY3JlYXRvclByb2ZpbGUsIHJlYWRlclByb2ZpbGUgfSBmcm9tIFwiLi4vbW9kZWwvc2NoZW1hXCI7XHJcbmltcG9ydCB7IE9BdXRoMkNsaWVudCB9IGZyb20gXCJnb29nbGUtYXV0aC1saWJyYXJ5XCI7XHJcbmltcG9ydCB7IGVxIH0gZnJvbSBcImRyaXp6bGUtb3JtXCI7XHJcblxyXG5jb25zdCBjbGllbnQgPSBuZXcgT0F1dGgyQ2xpZW50KHByb2Nlc3MuZW52LkdPT0dMRV9DTElFTlRfSUQpO1xyXG5cclxuZXhwb3J0IGNvbnN0IGdvb2dsZUF1dGhDb250cm9sbGVyID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHsgaWRUb2tlbiB9ID0gcmVxLmJvZHk7XHJcbiAgICBpZiAoIWlkVG9rZW4pIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6IFwiR29vZ2xlIElEIHRva2VuIHJlcXVpcmVkXCIgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFwcm9jZXNzLmVudi5HT09HTEVfQ0xJRU5UX0lEKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IG1lc3NhZ2U6IFwiQ2xpZW50IGlkIGlzIG5vdCBkZWZpbmVkXCIgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g4pyFIFZlcmlmeSB0b2tlbiB3aXRoIEdvb2dsZVxyXG4gICAgY29uc3QgdGlja2V0ID0gYXdhaXQgY2xpZW50LnZlcmlmeUlkVG9rZW4oe1xyXG4gICAgICBpZFRva2VuLFxyXG4gICAgICBhdWRpZW5jZTogcHJvY2Vzcy5lbnYuR09PR0xFX0NMSUVOVF9JRCxcclxuICAgIH0pO1xyXG4gICAgY29uc3QgcGF5bG9hZCA9IHRpY2tldC5nZXRQYXlsb2FkKCk7XHJcblxyXG4gICAgaWYgKCFwYXlsb2FkKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIEdvb2dsZSB0b2tlblwiKTtcclxuXHJcbiAgICBjb25zdCB7IGVtYWlsLCBzdWI6IGdvb2dsZUlkLCBwaWN0dXJlIH0gPSBwYXlsb2FkO1xyXG5cclxuICAgIC8vIOKchSBDaGVjayBpZiB1c2VyIGFscmVhZHkgZXhpc3RzXHJcbiAgICBjb25zdCB1c2VycyA9IGF3YWl0IGRiXHJcbiAgICAgIC5zZWxlY3QoKVxyXG4gICAgICAuZnJvbShhdXRoVXNlcnMpXHJcbiAgICAgIC53aGVyZShlcShhdXRoVXNlcnMuZW1haWwsIGVtYWlsKSk7XHJcbiAgICBsZXQgdXNlciA9IHVzZXJzWzBdID8/IG51bGw7XHJcblxyXG4gICAgaWYgKCF1c2VyKSB7XHJcbiAgICAgIC8vIOKchSBDcmVhdGUgbmV3IHVzZXIgaWYgbm90IGZvdW5kXHJcbiAgICAgIGNvbnN0IFtuZXdVc2VyXSA9IGF3YWl0IGRiXHJcbiAgICAgICAgLmluc2VydChhdXRoVXNlcnMpXHJcbiAgICAgICAgLnZhbHVlcyh7XHJcbiAgICAgICAgICBlbWFpbCxcclxuICAgICAgICAgIHVzZXJuYW1lOiBlbWFpbC5zcGxpdChcIkBcIilbMF0sXHJcbiAgICAgICAgICBlbWFpbFZlcmlmaWVkOiB0cnVlLFxyXG4gICAgICAgICAgaXNBY3RpdmU6IHRydWUsXHJcbiAgICAgICAgICBwYXNzd29yZEhhc2g6IFwiXCIsXHJcbiAgICAgICAgfSlcclxuICAgICAgICAucmV0dXJuaW5nKCk7XHJcblxyXG4gICAgICB1c2VyID0gbmV3VXNlcjtcclxuICAgIH1cclxuXHJcbiAgICAvLyDwn5SNIENoZWNrIGlmIHByb2ZpbGUgZXhpc3RzIChjcmVhdG9yIE9SIHJlYWRlcilcclxuICAgIGNvbnN0IFtjcmVhdG9yXSA9IGF3YWl0IGRiXHJcbiAgICAgIC5zZWxlY3QoKVxyXG4gICAgICAuZnJvbShjcmVhdG9yUHJvZmlsZSlcclxuICAgICAgLndoZXJlKGVxKGNyZWF0b3JQcm9maWxlLnVzZXJJZCwgdXNlci5pZCkpO1xyXG5cclxuICAgIGNvbnN0IFtyZWFkZXJdID0gYXdhaXQgZGJcclxuICAgICAgLnNlbGVjdCgpXHJcbiAgICAgIC5mcm9tKHJlYWRlclByb2ZpbGUpXHJcbiAgICAgIC53aGVyZShlcShyZWFkZXJQcm9maWxlLnVzZXJJZCwgdXNlci5pZCkpO1xyXG5cclxuICAgIGNvbnN0IGNQcm9maWxlID0gISFjcmVhdG9yO1xyXG4gICAgY29uc29sZS5sb2coXCJjUHJvZmlsZVwiLCBjUHJvZmlsZSk7XHJcbiAgICBjb25zdCByUHJvZmlsZSA9ICEhcmVhZGVyO1xyXG4gICAgY29uc29sZS5sb2coXCJyUHJvZmlsZVwiLCByUHJvZmlsZSk7XHJcblxyXG4gICAgLy8g4pyFIEdlbmVyYXRlIEpXVFxyXG4gICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbihcclxuICAgICAgeyB1c2VySWQ6IHVzZXIuaWQsIGVtYWlsOiB1c2VyLmVtYWlsIH0sXHJcbiAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQhLFxyXG4gICAgICB7XHJcbiAgICAgICAgZXhwaXJlc0luOiBcIjdkXCIsXHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgdG9rZW4sXHJcbiAgICAgIHVzZXIsXHJcbiAgICAgIGNQcm9maWxlLFxyXG4gICAgICByUHJvZmlsZSxcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgcmV0dXJuIHJlc1xyXG4gICAgICAuc3RhdHVzKDUwMClcclxuICAgICAgLmpzb24oeyBtZXNzYWdlOiBlcnIubWVzc2FnZSB8fCBcIkludGVybmFsIFNlcnZlciBFcnJvclwiIH0pO1xyXG4gIH1cclxufTtcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlHb29nbGVUb2tlbihpZFRva2VuOiBzdHJpbmcpIHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgdGlja2V0ID0gYXdhaXQgY2xpZW50LnZlcmlmeUlkVG9rZW4oe1xyXG4gICAgICBpZFRva2VuLFxyXG4gICAgICBhdWRpZW5jZTogcHJvY2Vzcy5lbnYuR09PR0xFX0NMSUVOVF9JRCxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHBheWxvYWQgPSB0aWNrZXQuZ2V0UGF5bG9hZCgpO1xyXG4gICAgaWYgKCFwYXlsb2FkKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIEdvb2dsZSB0b2tlblwiKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBlbWFpbDogcGF5bG9hZC5lbWFpbCEsXHJcbiAgICAgIGZ1bGxOYW1lOiBwYXlsb2FkLm5hbWUgfHwgXCJcIixcclxuICAgICAgcGljdHVyZTogcGF5bG9hZC5waWN0dXJlIHx8IFwiXCIsXHJcbiAgICAgIGdvb2dsZUlkOiBwYXlsb2FkLnN1YixcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byB2ZXJpZnkgR29vZ2xlIHRva2VuXCIpO1xyXG4gIH1cclxufVxyXG4iXX0=