import { eq } from "drizzle-orm";
import { db } from "../config/db";
import { comics } from "../model/comic";
import jwt from "jsonwebtoken";
import { creatorProfile } from "../model/profile";
export const createComic = async (req, res) => {
    try {
        const { title, language, ageRating, description, image, genre, tags } = req.body;
        const authHeader = req.headers.authorization;
        if (!authHeader || !authHeader.startsWith("Bearer ")) {
            return res.status(401).json({ message: "Unauthorized" });
        }
        const token = authHeader.split(" ")[1];
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        const userId = decoded.userId;
        const [creator] = await db
            .select()
            .from(creatorProfile)
            .where(eq(creatorProfile.userId, userId));
        if (!creator) {
            return res.status(404).json({ message: "User not found" });
        }
        const slug = `${title.toLowerCase().replace(/[^a-z0-9]+/g, "-")}-${decoded.email}`;
        const [comic] = await db
            .insert(comics)
            .values({
            title,
            language,
            ageRating,
            description,
            image,
            slug,
            genre,
            tags,
            creatorId: creator.id,
        })
            .returning();
        return res.status(200).json({ comic, slug });
    }
    catch (err) {
        console.error(err);
        return res.status(400).json({ message: "Failed to create comic" });
    }
};
export const fetchAllComicByJwt = async (req, res) => {
    try {
        const authHeader = req.headers.authorization;
        if (!authHeader || !authHeader.startsWith("Bearer ")) {
            return res.status(401).json({ message: "Unauthorized" });
        }
        const token = authHeader.split(" ")[1];
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        const userId = decoded.userId;
        const [creator] = await db
            .select()
            .from(creatorProfile)
            .where(eq(creatorProfile.userId, userId));
        if (!creator) {
            return res.status(404).json({ message: "Creator With Jwt not found" });
        }
        const userComics = await db
            .select()
            .from(comics)
            .where(eq(comics.creatorId, creator.id));
        return res.json({ comics: userComics });
    }
    catch (err) {
        console.error(err);
        return res.status(400).json({ message: "Failed to fetch comics" });
    }
};
export const fetchComicBySlug = async (req, res) => {
    try {
        const { slug } = req.params;
        const [comic] = await db.select().from(comics).where(eq(comics.slug, slug));
        console.log("comic found");
        if (!comic)
            return res.status(404).json({ message: "Comic not found" });
        return res.json({ comic });
    }
    catch (err) {
        console.error(err);
        return res.status(400).json({ message: "Failed to fetch comic" });
    }
};
// ✅ Fetch all comics (reader endpoint)
export const fetchAllComics = async (req, res) => {
    try {
        console.log("AllComics");
        const allComics = await db.select().from(comics);
        console.log("AllComics", allComics);
        return res.json({ comics: allComics });
    }
    catch (err) {
        console.error(err);
        return res.status(400).json({ message: "Failed to fetch comics" });
    }
};
// ✅ Search comics by title
// export const searchComics = async (req, res) => {
//   try {
//     const { q } = req.query; // frontend sends /comics/search?q=title
//     if (!q) return res.status(400).json({ message: "Search query required" });
//     const results = await db
//       .select()
//       .from(comics)
//       .where(ilike(comics.title, `%${q}%`));
//     return res.json({ results });
//   } catch (err) {
//     console.error(err);
//     return res.status(400).json({ message: "Failed to search comics" });
//   }
// };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29taWMuY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbWljLmNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNqQyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDL0IsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWxELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQzVDLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FDbkUsR0FBRyxDQUFDLElBQUksQ0FBQztRQUNYLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO1FBQzdDLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDckQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFFRCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sT0FBTyxHQUFRLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVyxDQUFDLENBQUM7UUFFaEUsTUFBTSxNQUFN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QUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRix1Q0FBdUM7QUFDdkMsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDL0MsSUFBSSxDQUFDO1FBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6QixNQUFNLFNBQVMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFFcEMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRiwyQkFBMkI7QUFDM0Isb0RBQW9EO0FBQ3BELFVBQVU7QUFDVix3RUFBd0U7QUFDeEUsaUZBQWlGO0FBRWpGLCtCQUErQjtBQUMvQixrQkFBa0I7QUFDbEIsc0JBQXNCO0FBQ3RCLCtDQUErQztBQUUvQyxvQ0FBb0M7QUFDcEMsb0JBQW9CO0FBQ3BCLDBCQUEwQjtBQUMxQiwyRUFBMkU7QUFDM0UsTUFBTTtBQUNOLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcSB9IGZyb20gXCJkcml6emxlLW9ybVwiO1xyXG5pbXBvcnQgeyBkYiB9IGZyb20gXCIuLi9jb25maWcvZGJcIjtcclxuaW1wb3J0IHsgY29taWNzIH0gZnJvbSBcIi4uL21vZGVsL2NvbWljXCI7XHJcbmltcG9ydCBqd3QgZnJvbSBcImpzb253ZWJ0b2tlblwiO1xyXG5pbXBvcnQgeyBjcmVhdG9yUHJvZmlsZSB9IGZyb20gXCIuLi9tb2RlbC9wcm9maWxlXCI7XHJcblxyXG5leHBvcnQgY29uc3QgY3JlYXRlQ29taWMgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyB0aXRsZSwgbGFuZ3VhZ2UsIGFnZVJhdGluZywgZGVzY3JpcHRpb24sIGltYWdlLCBnZW5yZSwgdGFncyB9ID1cclxuICAgICAgcmVxLmJvZHk7XHJcbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcclxuICAgIGlmICghYXV0aEhlYWRlciB8fCAhYXV0aEhlYWRlci5zdGFydHNXaXRoKFwiQmVhcmVyIFwiKSkge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBtZXNzYWdlOiBcIlVuYXV0aG9yaXplZFwiIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRva2VuID0gYXV0aEhlYWRlci5zcGxpdChcIiBcIilbMV07XHJcbiAgICBjb25zdCBkZWNvZGVkOiBhbnkgPSBqd3QudmVyaWZ5KHRva2VuLCBwcm9jZXNzLmVudi5KV1RfU0VDUkVUISk7XHJcblxyXG4gICAgY29uc3QgdXNlcklkID0gZGVjb2RlZC51c2VySWQ7XHJcblxyXG4gICAgY29uc3QgW2NyZWF0b3JdID0gYXdhaXQgZGJcclxuICAgICAgLnNlbGVjdCgpXHJcbiAgICAgIC5mcm9tKGNyZWF0b3JQcm9maWxlKVxyXG4gICAgICAud2hlcmUoZXEoY3JlYXRvclByb2ZpbGUudXNlcklkLCB1c2VySWQpKTtcclxuXHJcbiAgICBpZiAoIWNyZWF0b3IpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogXCJVc2VyIG5vdCBmb3VuZFwiIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNsdWcgPSBgJHt0aXRsZS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1teYS16MC05XSsvZywgXCItXCIpfS0ke1xyXG4gICAgICBkZWNvZGVkLmVtYWlsXHJcbiAgICB9YDtcclxuXHJcbiAgICBjb25zdCBbY29taWNdID0gYXdhaXQgZGJcclxuICAgICAgLmluc2VydChjb21pY3MpXHJcbiAgICAgIC52YWx1ZXMoe1xyXG4gICAgICAgIHRpdGxlLFxyXG4gICAgICAgIGxhbmd1YWdlLFxyXG4gICAgICAgIGFnZVJhdGluZyxcclxuICAgICAgICBkZXNjcmlwdGlvbixcclxuICAgICAgICBpbWFnZSxcclxuICAgICAgICBzbHVnLFxyXG4gICAgICAgIGdlbnJlLFxyXG4gICAgICAgIHRhZ3MsXHJcbiAgICAgICAgY3JlYXRvcklkOiBjcmVhdG9yLmlkLFxyXG4gICAgICB9KVxyXG4gICAgICAucmV0dXJuaW5nKCk7XHJcblxyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgY29taWMsIHNsdWcgfSk7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiBcIkZhaWxlZCB0byBjcmVhdGUgY29taWNcIiB9KTtcclxuICB9XHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgZmV0Y2hBbGxDb21pY0J5Snd0ID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uO1xyXG4gICAgaWYgKCFhdXRoSGVhZGVyIHx8ICFhdXRoSGVhZGVyLnN0YXJ0c1dpdGgoXCJCZWFyZXIgXCIpKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkXCIgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdG9rZW4gPSBhdXRoSGVhZGVyLnNwbGl0KFwiIFwiKVsxXTtcclxuICAgIGNvbnN0IGRlY29kZWQ6IGFueSA9IGp3dC52ZXJpZnkodG9rZW4sIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQhKTtcclxuXHJcbiAgICBjb25zdCB1c2VySWQgPSBkZWNvZGVkLnVzZXJJZDtcclxuXHJcbiAgICBjb25zdCBbY3JlYXRvcl0gPSBhd2FpdCBkYlxyXG4gICAgICAuc2VsZWN0KClcclxuICAgICAgLmZyb20oY3JlYXRvclByb2ZpbGUpXHJcbiAgICAgIC53aGVyZShlcShjcmVhdG9yUHJvZmlsZS51c2VySWQsIHVzZXJJZCkpO1xyXG4gICAgaWYgKCFjcmVhdG9yKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6IFwiQ3JlYXRvciBXaXRoIEp3dCBub3QgZm91bmRcIiB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1c2VyQ29taWNzID0gYXdhaXQgZGJcclxuICAgICAgLnNlbGVjdCgpXHJcbiAgICAgIC5mcm9tKGNvbWljcylcclxuICAgICAgLndoZXJlKGVxKGNvbWljcy5jcmVhdG9ySWQsIGNyZWF0b3IuaWQpKTtcclxuXHJcbiAgICByZXR1cm4gcmVzLmpzb24oeyBjb21pY3M6IHVzZXJDb21pY3MgfSk7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiBcIkZhaWxlZCB0byBmZXRjaCBjb21pY3NcIiB9KTtcclxuICB9XHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgZmV0Y2hDb21pY0J5U2x1ZyA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IHNsdWcgfSA9IHJlcS5wYXJhbXM7XHJcblxyXG4gICAgY29uc3QgW2NvbWljXSA9IGF3YWl0IGRiLnNlbGVjdCgpLmZyb20oY29taWNzKS53aGVyZShlcShjb21pY3Muc2x1Zywgc2x1ZykpO1xyXG4gICAgY29uc29sZS5sb2coXCJjb21pYyBmb3VuZFwiKTtcclxuXHJcbiAgICBpZiAoIWNvbWljKSByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiBcIkNvbWljIG5vdCBmb3VuZFwiIH0pO1xyXG5cclxuICAgIHJldHVybiByZXMuanNvbih7IGNvbWljIH0pO1xyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogXCJGYWlsZWQgdG8gZmV0Y2ggY29taWNcIiB9KTtcclxuICB9XHJcbn07XHJcblxyXG4vLyDinIUgRmV0Y2ggYWxsIGNvbWljcyAocmVhZGVyIGVuZHBvaW50KVxyXG5leHBvcnQgY29uc3QgZmV0Y2hBbGxDb21pY3MgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc29sZS5sb2coXCJBbGxDb21pY3NcIik7XHJcbiAgICBjb25zdCBhbGxDb21pY3MgPSBhd2FpdCBkYi5zZWxlY3QoKS5mcm9tKGNvbWljcyk7XHJcbiAgICBjb25zb2xlLmxvZyhcIkFsbENvbWljc1wiLCBhbGxDb21pY3MpO1xyXG5cclxuICAgIHJldHVybiByZXMuanNvbih7IGNvbWljczogYWxsQ29taWNzIH0pO1xyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogXCJGYWlsZWQgdG8gZmV0Y2ggY29taWNzXCIgfSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8g4pyFIFNlYXJjaCBjb21pY3MgYnkgdGl0bGVcclxuLy8gZXhwb3J0IGNvbnN0IHNlYXJjaENvbWljcyA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xyXG4vLyAgIHRyeSB7XHJcbi8vICAgICBjb25zdCB7IHEgfSA9IHJlcS5xdWVyeTsgLy8gZnJvbnRlbmQgc2VuZHMgL2NvbWljcy9zZWFyY2g/cT10aXRsZVxyXG4vLyAgICAgaWYgKCFxKSByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiBcIlNlYXJjaCBxdWVyeSByZXF1aXJlZFwiIH0pO1xyXG5cclxuLy8gICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBkYlxyXG4vLyAgICAgICAuc2VsZWN0KClcclxuLy8gICAgICAgLmZyb20oY29taWNzKVxyXG4vLyAgICAgICAud2hlcmUoaWxpa2UoY29taWNzLnRpdGxlLCBgJSR7cX0lYCkpO1xyXG5cclxuLy8gICAgIHJldHVybiByZXMuanNvbih7IHJlc3VsdHMgfSk7XHJcbi8vICAgfSBjYXRjaCAoZXJyKSB7XHJcbi8vICAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbi8vICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiBcIkZhaWxlZCB0byBzZWFyY2ggY29taWNzXCIgfSk7XHJcbi8vICAgfVxyXG4vLyB9O1xyXG4iXX0=